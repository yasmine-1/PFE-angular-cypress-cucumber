import { Pipe, Inject } from '@angular/core';
import { DatePipe } from '@angular/common';
import { IGX_TIME_PICKER_COMPONENT } from './time-picker.common';
import { DatePart } from '../directives/date-time-editor/public_api';
import * as i0 from "@angular/core";
const ITEMS_COUNT = 7;
export class TimeFormatPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(value) {
        const format = this.timePicker.inputFormat.replace('tt', 'aa');
        const datePipe = new DatePipe(this.timePicker.locale);
        return datePipe.transform(value, format);
    }
}
TimeFormatPipe.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeFormatPipe, deps: [{ token: IGX_TIME_PICKER_COMPONENT }], target: i0.ɵɵFactoryTarget.Pipe });
TimeFormatPipe.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeFormatPipe, name: "timeFormatPipe" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeFormatPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'timeFormatPipe'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [IGX_TIME_PICKER_COMPONENT]
                }] }]; } });
export class TimeItemPipe {
    constructor(timePicker) {
        this.timePicker = timePicker;
    }
    transform(_collection, timePart, selectedDate, min, max) {
        let list;
        let part;
        switch (timePart) {
            case 'hour':
                list = this.generateHours(min, max);
                const hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(selectedDate.getHours())
                    : selectedDate.getHours();
                list = this.scrollListItem(hours, list);
                part = DatePart.Hours;
                break;
            case 'minutes':
                list = this.generateMinutes(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getMinutes(), list);
                part = DatePart.Minutes;
                break;
            case 'seconds':
                list = this.generateSeconds(selectedDate, min, max);
                list = this.scrollListItem(selectedDate.getSeconds(), list);
                part = DatePart.Seconds;
                break;
            case 'ampm':
                list = this.generateAmPm(min, max);
                const selectedAmPm = this.timePicker.getPartValue(selectedDate, 'ampm');
                list = this.scrollListItem(selectedAmPm, list);
                part = DatePart.AmPm;
                break;
        }
        return this.getListView(list, part);
    }
    getListView(view, dateType) {
        for (let i = 0; i < view.length; i++) {
            view[i] = this.getItemView(view[i], dateType);
        }
        return view;
    }
    getItemView(item, dateType) {
        if (item === null) {
            item = '';
        }
        else if (dateType && typeof (item) !== 'string') {
            const leadZeroHour = (item < 10 && (this.timePicker.inputFormat.indexOf('hh') !== -1
                || this.timePicker.inputFormat.indexOf('HH') !== -1));
            const leadZeroMinute = (item < 10 && this.timePicker.inputFormat.indexOf('mm') !== -1);
            const leadZeroSeconds = (item < 10 && this.timePicker.inputFormat.indexOf('ss') !== -1);
            const leadZero = {
                hours: leadZeroHour,
                minutes: leadZeroMinute,
                seconds: leadZeroSeconds
            }[dateType];
            item = (leadZero) ? '0' + item : `${item}`;
        }
        return item;
    }
    scrollListItem(item, items) {
        const itemsCount = items.length;
        let view;
        if (items) {
            const index = items.indexOf(item);
            if (index < 3) {
                view = items.slice(itemsCount - (3 - index), itemsCount);
                view = view.concat(items.slice(0, index + 4));
            }
            else if (index + 4 > itemsCount) {
                view = items.slice(index - 3, itemsCount);
                view = view.concat(items.slice(0, index + 4 - itemsCount));
            }
            else {
                view = items.slice(index - 3, index + 4);
            }
        }
        return view;
    }
    generateHours(min, max) {
        const hourItems = [];
        let hoursCount = this.timePicker.isTwelveHourFormat ? 13 : 24;
        hoursCount /= this.timePicker.itemsDelta.hours;
        const minHours = min.getHours();
        const maxHours = max.getHours();
        if (hoursCount > 1) {
            for (let hourIndex = 0; hourIndex < 24; hourIndex++) {
                let hours = hourIndex * this.timePicker.itemsDelta.hours;
                if (hours >= minHours && hours <= maxHours) {
                    hours = this.timePicker.isTwelveHourFormat ? this.toTwelveHourFormat(hours) : hours;
                    if (!hourItems.find((element => element === hours))) {
                        hourItems.push(hours);
                    }
                }
            }
        }
        else {
            hourItems.push(0);
        }
        if (hourItems.length < ITEMS_COUNT || hoursCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (hourItems.length < ITEMS_COUNT && hoursCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                hourItems.push(null);
            }
        }
        return hourItems;
    }
    generateMinutes(time, min, max) {
        const minuteItems = [];
        const minuteItemsCount = 60 / this.timePicker.itemsDelta.minutes;
        time = new Date(time);
        for (let i = 0; i < minuteItemsCount; i++) {
            const minutes = i * this.timePicker.itemsDelta.minutes;
            time.setMinutes(minutes);
            if (time >= min && time <= max) {
                minuteItems.push(i * this.timePicker.itemsDelta.minutes);
            }
        }
        if (minuteItems.length < ITEMS_COUNT || minuteItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (minuteItems.length < ITEMS_COUNT && minuteItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                minuteItems.push(null);
            }
        }
        return minuteItems;
    }
    generateSeconds(time, min, max) {
        const secondsItems = [];
        const secondsItemsCount = 60 / this.timePicker.itemsDelta.seconds;
        time = new Date(time);
        for (let i = 0; i < secondsItemsCount; i++) {
            const seconds = i * this.timePicker.itemsDelta.seconds;
            time.setSeconds(seconds);
            if (time.getTime() >= min.getTime()
                && time.getTime() <= max.getTime()) {
                secondsItems.push(i * this.timePicker.itemsDelta.seconds);
            }
        }
        if (secondsItems.length < ITEMS_COUNT || secondsItemsCount < ITEMS_COUNT || !this.timePicker.spinLoop) {
            const index = !this.timePicker.spinLoop || (secondsItems.length < ITEMS_COUNT && secondsItemsCount < ITEMS_COUNT) ? 6 : 3;
            for (let i = 0; i < index; i++) {
                secondsItems.push(null);
            }
        }
        return secondsItems;
    }
    generateAmPm(min, max) {
        const ampmItems = [];
        const minHour = min.getHours();
        const maxHour = max.getHours();
        if (minHour < 12) {
            ampmItems.push('AM');
        }
        if (minHour >= 12 || maxHour >= 12) {
            ampmItems.push('PM');
        }
        for (let i = 0; i < 5; i++) {
            ampmItems.push(null);
        }
        return ampmItems;
    }
    toTwelveHourFormat(hour) {
        if (hour > 12) {
            hour -= 12;
        }
        else if (hour === 0) {
            hour = 12;
        }
        return hour;
    }
}
TimeItemPipe.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeItemPipe, deps: [{ token: IGX_TIME_PICKER_COMPONENT }], target: i0.ɵɵFactoryTarget.Pipe });
TimeItemPipe.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeItemPipe, name: "timeItemPipe" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: TimeItemPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'timeItemPipe'
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [IGX_TIME_PICKER_COMPONENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZS1waWNrZXIucGlwZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvdGltZS1waWNrZXIvdGltZS1waWNrZXIucGlwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLElBQUksRUFBaUIsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzVELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQUUseUJBQXlCLEVBQXFCLE1BQU0sc0JBQXNCLENBQUM7QUFDcEYsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLDJDQUEyQyxDQUFDOztBQUVyRSxNQUFNLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFLdEIsTUFBTSxPQUFPLGNBQWM7SUFDdkIsWUFBdUQsVUFBNkI7UUFBN0IsZUFBVSxHQUFWLFVBQVUsQ0FBbUI7SUFBSSxDQUFDO0lBRWxGLFNBQVMsQ0FBQyxLQUFXO1FBQ3hCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0QsTUFBTSxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0RCxPQUFPLFFBQVEsQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0lBQzdDLENBQUM7OzJHQVBRLGNBQWMsa0JBQ0gseUJBQXlCO3lHQURwQyxjQUFjOzJGQUFkLGNBQWM7a0JBSDFCLElBQUk7bUJBQUM7b0JBQ0YsSUFBSSxFQUFFLGdCQUFnQjtpQkFDekI7OzBCQUVnQixNQUFNOzJCQUFDLHlCQUF5Qjs7QUFZakQsTUFBTSxPQUFPLFlBQVk7SUFDckIsWUFBdUQsVUFBNkI7UUFBN0IsZUFBVSxHQUFWLFVBQVUsQ0FB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UUFDckIsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQy9CLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUUvQixJQUFJLE9BQU8sR0FBRyxFQUFFLEVBQUU7WUFDZCxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxPQUFPLElBQUksRUFBRSxJQUFJLE9BQU8sSUFBSSxFQUFFLEVBQUU7WUFDaEMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtRQUVELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDeEIsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4QjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ3JCLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxJQUFZO1FBQ25DLElBQUksSUFBSSxHQUFHLEVBQUUsRUFBRTtZQUNYLElBQUksSUFBSSxFQUFFLENBQUM7U0FDZDthQUFNLElBQUksSUFBSSxLQUFLLENBQUMsRUFBRTtZQUNuQixJQUFJLEdBQUcsRUFBRSxDQUFDO1NBQ2I7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDOzt5R0F6TFEsWUFBWSxrQkFDRCx5QkFBeUI7dUdBRHBDLFlBQVk7MkZBQVosWUFBWTtrQkFIeEIsSUFBSTttQkFBQztvQkFDRixJQUFJLEVBQUUsY0FBYztpQkFDdkI7OzBCQUVnQixNQUFNOzJCQUFDLHlCQUF5QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBpcGUsIFBpcGVUcmFuc2Zvcm0sIEluamVjdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRGF0ZVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgSUdYX1RJTUVfUElDS0VSX0NPTVBPTkVOVCwgSWd4VGltZVBpY2tlckJhc2UgfSBmcm9tICcuL3RpbWUtcGlja2VyLmNvbW1vbic7XG5pbXBvcnQgeyBEYXRlUGFydCB9IGZyb20gJy4uL2RpcmVjdGl2ZXMvZGF0ZS10aW1lLWVkaXRvci9wdWJsaWNfYXBpJztcblxuY29uc3QgSVRFTVNfQ09VTlQgPSA3O1xuXG5AUGlwZSh7XG4gICAgbmFtZTogJ3RpbWVGb3JtYXRQaXBlJ1xufSlcbmV4cG9ydCBjbGFzcyBUaW1lRm9ybWF0UGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoSUdYX1RJTUVfUElDS0VSX0NPTVBPTkVOVCkgcHJpdmF0ZSB0aW1lUGlja2VyOiBJZ3hUaW1lUGlja2VyQmFzZSkgeyB9XG5cbiAgICBwdWJsaWMgdHJhbnNmb3JtKHZhbHVlOiBEYXRlKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZm9ybWF0ID0gdGhpcy50aW1lUGlja2VyLmlucHV0Rm9ybWF0LnJlcGxhY2UoJ3R0JywgJ2FhJyk7XG4gICAgICAgIGNvbnN0IGRhdGVQaXBlID0gbmV3IERhdGVQaXBlKHRoaXMudGltZVBpY2tlci5sb2NhbGUpO1xuICAgICAgICByZXR1cm4gZGF0ZVBpcGUudHJhbnNmb3JtKHZhbHVlLCBmb3JtYXQpO1xuICAgIH1cbn1cblxuQFBpcGUoe1xuICAgIG5hbWU6ICd0aW1lSXRlbVBpcGUnXG59KVxuZXhwb3J0IGNsYXNzIFRpbWVJdGVtUGlwZSBpbXBsZW1lbnRzIFBpcGVUcmFuc2Zvcm0ge1xuICAgIGNvbnN0cnVjdG9yKEBJbmplY3QoSUdYX1RJTUVfUElDS0VSX0NPTVBPTkVOVCkgcHJpdmF0ZSB0aW1lUGlja2VyOiBJZ3hUaW1lUGlja2VyQmFzZSkgeyB9XG5cbiAgICBwdWJsaWMgdHJhbnNmb3JtKF9jb2xsZWN0aW9uOiBhbnlbXSwgdGltZVBhcnQ6IHN0cmluZywgc2VsZWN0ZWREYXRlOiBEYXRlLCBtaW46IERhdGUsIG1heDogRGF0ZSkge1xuICAgICAgICBsZXQgbGlzdDtcbiAgICAgICAgbGV0IHBhcnQ7XG4gICAgICAgIHN3aXRjaCAodGltZVBhcnQpIHtcbiAgICAgICAgICAgIGNhc2UgJ2hvdXInOlxuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLmdlbmVyYXRlSG91cnMobWluLCBtYXgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGhvdXJzID0gdGhpcy50aW1lUGlja2VyLmlzVHdlbHZlSG91ckZvcm1hdCA/IHRoaXMudG9Ud2VsdmVIb3VyRm9ybWF0KHNlbGVjdGVkRGF0ZS5nZXRIb3VycygpKVxuICAgICAgICAgICAgICAgICAgICA6IHNlbGVjdGVkRGF0ZS5nZXRIb3VycygpO1xuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLnNjcm9sbExpc3RJdGVtKGhvdXJzLCBsaXN0KTtcbiAgICAgICAgICAgICAgICBwYXJ0ID0gRGF0ZVBhcnQuSG91cnM7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdtaW51dGVzJzpcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5nZW5lcmF0ZU1pbnV0ZXMoc2VsZWN0ZWREYXRlLCBtaW4sIG1heCk7XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuc2Nyb2xsTGlzdEl0ZW0oc2VsZWN0ZWREYXRlLmdldE1pbnV0ZXMoKSwgbGlzdCk7XG4gICAgICAgICAgICAgICAgcGFydCA9IERhdGVQYXJ0Lk1pbnV0ZXM7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdzZWNvbmRzJzpcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5nZW5lcmF0ZVNlY29uZHMoc2VsZWN0ZWREYXRlLCBtaW4sIG1heCk7XG4gICAgICAgICAgICAgICAgbGlzdCA9IHRoaXMuc2Nyb2xsTGlzdEl0ZW0oc2VsZWN0ZWREYXRlLmdldFNlY29uZHMoKSwgbGlzdCk7XG4gICAgICAgICAgICAgICAgcGFydCA9IERhdGVQYXJ0LlNlY29uZHM7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlICdhbXBtJzpcbiAgICAgICAgICAgICAgICBsaXN0ID0gdGhpcy5nZW5lcmF0ZUFtUG0obWluLCBtYXgpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHNlbGVjdGVkQW1QbSA9IHRoaXMudGltZVBpY2tlci5nZXRQYXJ0VmFsdWUoc2VsZWN0ZWREYXRlLCAnYW1wbScpO1xuICAgICAgICAgICAgICAgIGxpc3QgPSB0aGlzLnNjcm9sbExpc3RJdGVtKHNlbGVjdGVkQW1QbSwgbGlzdCk7XG4gICAgICAgICAgICAgICAgcGFydCA9IERhdGVQYXJ0LkFtUG07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0TGlzdFZpZXcobGlzdCwgcGFydCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRMaXN0Vmlldyh2aWV3OiBhbnksIGRhdGVUeXBlOiBEYXRlUGFydCk6IGFueSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdmlldy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdmlld1tpXSA9IHRoaXMuZ2V0SXRlbVZpZXcodmlld1tpXSwgZGF0ZVR5cGUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB2aWV3O1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0SXRlbVZpZXcoaXRlbTogYW55LCBkYXRlVHlwZTogRGF0ZVBhcnQpOiBzdHJpbmcge1xuICAgICAgICBpZiAoaXRlbSA9PT0gbnVsbCkge1xuICAgICAgICAgICAgaXRlbSA9ICcnO1xuICAgICAgICB9IGVsc2UgaWYgKGRhdGVUeXBlICYmIHR5cGVvZiAoaXRlbSkgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBjb25zdCBsZWFkWmVyb0hvdXIgPSAoaXRlbSA8IDEwICYmICh0aGlzLnRpbWVQaWNrZXIuaW5wdXRGb3JtYXQuaW5kZXhPZignaGgnKSAhPT0gLTFcbiAgICAgICAgICAgICAgICB8fCB0aGlzLnRpbWVQaWNrZXIuaW5wdXRGb3JtYXQuaW5kZXhPZignSEgnKSAhPT0gLTEpKTtcbiAgICAgICAgICAgIGNvbnN0IGxlYWRaZXJvTWludXRlID0gKGl0ZW0gPCAxMCAmJiB0aGlzLnRpbWVQaWNrZXIuaW5wdXRGb3JtYXQuaW5kZXhPZignbW0nKSAhPT0gLTEpO1xuICAgICAgICAgICAgY29uc3QgbGVhZFplcm9TZWNvbmRzID0gKGl0ZW0gPCAxMCAmJiB0aGlzLnRpbWVQaWNrZXIuaW5wdXRGb3JtYXQuaW5kZXhPZignc3MnKSAhPT0gLTEpO1xuXG4gICAgICAgICAgICBjb25zdCBsZWFkWmVybyA9IHtcbiAgICAgICAgICAgICAgICBob3VyczogbGVhZFplcm9Ib3VyLFxuICAgICAgICAgICAgICAgIG1pbnV0ZXM6IGxlYWRaZXJvTWludXRlLFxuICAgICAgICAgICAgICAgIHNlY29uZHM6IGxlYWRaZXJvU2Vjb25kc1xuICAgICAgICAgICAgfVtkYXRlVHlwZV07XG5cbiAgICAgICAgICAgIGl0ZW0gPSAobGVhZFplcm8pID8gJzAnICsgaXRlbSA6IGAke2l0ZW19YDtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNjcm9sbExpc3RJdGVtKGl0ZW06IG51bWJlciB8IHN0cmluZywgaXRlbXM6IGFueVtdKTogYW55W10ge1xuICAgICAgICBjb25zdCBpdGVtc0NvdW50ID0gaXRlbXMubGVuZ3RoO1xuICAgICAgICBsZXQgdmlldztcbiAgICAgICAgaWYgKGl0ZW1zKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGl0ZW1zLmluZGV4T2YoaXRlbSk7XG4gICAgICAgICAgICBpZiAoaW5kZXggPCAzKSB7XG4gICAgICAgICAgICAgICAgdmlldyA9IGl0ZW1zLnNsaWNlKGl0ZW1zQ291bnQgLSAoMyAtIGluZGV4KSwgaXRlbXNDb3VudCk7XG4gICAgICAgICAgICAgICAgdmlldyA9IHZpZXcuY29uY2F0KGl0ZW1zLnNsaWNlKDAsIGluZGV4ICsgNCkpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChpbmRleCArIDQgPiBpdGVtc0NvdW50KSB7XG4gICAgICAgICAgICAgICAgdmlldyA9IGl0ZW1zLnNsaWNlKGluZGV4IC0gMywgaXRlbXNDb3VudCk7XG4gICAgICAgICAgICAgICAgdmlldyA9IHZpZXcuY29uY2F0KGl0ZW1zLnNsaWNlKDAsIGluZGV4ICsgNCAtIGl0ZW1zQ291bnQpKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmlldyA9IGl0ZW1zLnNsaWNlKGluZGV4IC0gMywgaW5kZXggKyA0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdmlldztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdlbmVyYXRlSG91cnMobWluOiBEYXRlLCBtYXg6IERhdGUpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IGhvdXJJdGVtcyA9IFtdO1xuICAgICAgICBsZXQgaG91cnNDb3VudCA9IHRoaXMudGltZVBpY2tlci5pc1R3ZWx2ZUhvdXJGb3JtYXQgPyAxMyA6IDI0O1xuICAgICAgICBob3Vyc0NvdW50IC89IHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLmhvdXJzO1xuICAgICAgICBjb25zdCBtaW5Ib3VycyA9IG1pbi5nZXRIb3VycygpO1xuICAgICAgICBjb25zdCBtYXhIb3VycyA9IG1heC5nZXRIb3VycygpO1xuXG4gICAgICAgIGlmIChob3Vyc0NvdW50ID4gMSkge1xuICAgICAgICAgICAgZm9yIChsZXQgaG91ckluZGV4ID0gMDsgaG91ckluZGV4IDwgMjQ7IGhvdXJJbmRleCsrKSB7XG4gICAgICAgICAgICAgICAgbGV0IGhvdXJzID0gaG91ckluZGV4ICogdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEuaG91cnM7XG4gICAgICAgICAgICAgICAgaWYgKGhvdXJzID49IG1pbkhvdXJzICYmIGhvdXJzIDw9IG1heEhvdXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGhvdXJzID0gdGhpcy50aW1lUGlja2VyLmlzVHdlbHZlSG91ckZvcm1hdCA/IHRoaXMudG9Ud2VsdmVIb3VyRm9ybWF0KGhvdXJzKSA6IGhvdXJzO1xuICAgICAgICAgICAgICAgICAgICBpZiAoIWhvdXJJdGVtcy5maW5kKChlbGVtZW50ID0+IGVsZW1lbnQgPT09IGhvdXJzKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvdXJJdGVtcy5wdXNoKGhvdXJzKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGhvdXJJdGVtcy5wdXNoKDApO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGhvdXJJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCB8fCBob3Vyc0NvdW50IDwgSVRFTVNfQ09VTlQgfHwgIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCkge1xuICAgICAgICAgICAgY29uc3QgaW5kZXggPSAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wIHx8IChob3VySXRlbXMubGVuZ3RoIDwgSVRFTVNfQ09VTlQgJiYgaG91cnNDb3VudCA8IElURU1TX0NPVU5UKSA/IDYgOiAzO1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbmRleDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgaG91ckl0ZW1zLnB1c2gobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gaG91ckl0ZW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2VuZXJhdGVNaW51dGVzKHRpbWU6IERhdGUsIG1pbjogRGF0ZSwgbWF4OiBEYXRlKTogYW55W10ge1xuICAgICAgICBjb25zdCBtaW51dGVJdGVtcyA9IFtdO1xuICAgICAgICBjb25zdCBtaW51dGVJdGVtc0NvdW50ID0gNjAgLyB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5taW51dGVzO1xuICAgICAgICB0aW1lID0gbmV3IERhdGUodGltZSk7XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBtaW51dGVJdGVtc0NvdW50OyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBpICogdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEubWludXRlcztcbiAgICAgICAgICAgIHRpbWUuc2V0TWludXRlcyhtaW51dGVzKTtcbiAgICAgICAgICAgIGlmICh0aW1lID49IG1pbiAmJiB0aW1lIDw9IG1heCkge1xuICAgICAgICAgICAgICAgIG1pbnV0ZUl0ZW1zLnB1c2goaSAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLm1pbnV0ZXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG1pbnV0ZUl0ZW1zLmxlbmd0aCA8IElURU1TX0NPVU5UIHx8IG1pbnV0ZUl0ZW1zQ291bnQgPCBJVEVNU19DT1VOVCB8fCAhdGhpcy50aW1lUGlja2VyLnNwaW5Mb29wKSB7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3AgfHwgKG1pbnV0ZUl0ZW1zLmxlbmd0aCA8IElURU1TX0NPVU5UICYmIG1pbnV0ZUl0ZW1zQ291bnQgPCBJVEVNU19DT1VOVCkgPyA2IDogMztcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5kZXg7IGkrKykge1xuICAgICAgICAgICAgICAgIG1pbnV0ZUl0ZW1zLnB1c2gobnVsbCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gbWludXRlSXRlbXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZVNlY29uZHModGltZTogRGF0ZSwgbWluOiBEYXRlLCBtYXg6IERhdGUpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IHNlY29uZHNJdGVtcyA9IFtdO1xuICAgICAgICBjb25zdCBzZWNvbmRzSXRlbXNDb3VudCA9IDYwIC8gdGhpcy50aW1lUGlja2VyLml0ZW1zRGVsdGEuc2Vjb25kcztcbiAgICAgICAgdGltZSA9IG5ldyBEYXRlKHRpbWUpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2Vjb25kc0l0ZW1zQ291bnQ7IGkrKykge1xuICAgICAgICAgICAgY29uc3Qgc2Vjb25kcyA9IGkgKiB0aGlzLnRpbWVQaWNrZXIuaXRlbXNEZWx0YS5zZWNvbmRzO1xuICAgICAgICAgICAgdGltZS5zZXRTZWNvbmRzKHNlY29uZHMpO1xuICAgICAgICAgICAgaWYgKHRpbWUuZ2V0VGltZSgpID49IG1pbi5nZXRUaW1lKClcbiAgICAgICAgICAgICAgICAmJiB0aW1lLmdldFRpbWUoKSA8PSBtYXguZ2V0VGltZSgpKSB7XG4gICAgICAgICAgICAgICAgc2Vjb25kc0l0ZW1zLnB1c2goaSAqIHRoaXMudGltZVBpY2tlci5pdGVtc0RlbHRhLnNlY29uZHMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHNlY29uZHNJdGVtcy5sZW5ndGggPCBJVEVNU19DT1VOVCB8fCBzZWNvbmRzSXRlbXNDb3VudCA8IElURU1TX0NPVU5UIHx8ICF0aGlzLnRpbWVQaWNrZXIuc3Bpbkxvb3ApIHtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gIXRoaXMudGltZVBpY2tlci5zcGluTG9vcCB8fCAoc2Vjb25kc0l0ZW1zLmxlbmd0aCA8IElURU1TX0NPVU5UICYmIHNlY29uZHNJdGVtc0NvdW50IDwgSVRFTVNfQ09VTlQpID8gNiA6IDM7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGluZGV4OyBpKyspIHtcbiAgICAgICAgICAgICAgICBzZWNvbmRzSXRlbXMucHVzaChudWxsKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBzZWNvbmRzSXRlbXM7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUFtUG0obWluOiBEYXRlLCBtYXg6IERhdGUpOiBhbnlbXSB7XG4gICAgICAgIGNvbnN0IGFtcG1JdGVtcyA9IFtdO1xuICAgICAgICBjb25zdCBtaW5Ib3VyID0gbWluLmdldEhvdXJzKCk7XG4gICAgICAgIGNvbnN0IG1heEhvdXIgPSBtYXguZ2V0SG91cnMoKTtcblxuICAgICAgICBpZiAobWluSG91ciA8IDEyKSB7XG4gICAgICAgICAgICBhbXBtSXRlbXMucHVzaCgnQU0nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChtaW5Ib3VyID49IDEyIHx8IG1heEhvdXIgPj0gMTIpIHtcbiAgICAgICAgICAgIGFtcG1JdGVtcy5wdXNoKCdQTScpO1xuICAgICAgICB9XG5cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA1OyBpKyspIHtcbiAgICAgICAgICAgIGFtcG1JdGVtcy5wdXNoKG51bGwpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFtcG1JdGVtcztcbiAgICB9XG5cbiAgICBwcml2YXRlIHRvVHdlbHZlSG91ckZvcm1hdChob3VyOiBudW1iZXIpOiBudW1iZXIge1xuICAgICAgICBpZiAoaG91ciA+IDEyKSB7XG4gICAgICAgICAgICBob3VyIC09IDEyO1xuICAgICAgICB9IGVsc2UgaWYgKGhvdXIgPT09IDApIHtcbiAgICAgICAgICAgIGhvdXIgPSAxMjtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBob3VyO1xuICAgIH1cbn1cbiJdfQ==