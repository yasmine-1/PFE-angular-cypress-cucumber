import { Pipe } from '@angular/core';
import { formatDate } from '../../core/utils';
import { GridColumnDataType } from '../../data-operations/data-util';
import { IgxSorting } from '../common/strategy';
import * as i0 from "@angular/core";
const HIDDEN_FIELD_NAME = '_Igx_Hidden_Data_';
/**
 * @hidden
 * @internal
 */
class GroupByRecord {
}
export class ITreeGridAggregation {
}
export class IgxGroupedTreeGridSorting extends IgxSorting {
    static instance() {
        return this._instance || (this._instance = new IgxGroupedTreeGridSorting());
    }
    getFieldValue(obj, key, isDate = false, isTime = false) {
        const data = obj.data[HIDDEN_FIELD_NAME] ?
            obj.data.hasOwnProperty(key) ?
                obj.data :
                obj.data[HIDDEN_FIELD_NAME] :
            obj.data;
        return super.getFieldValue(data, key, isDate, isTime);
    }
}
IgxGroupedTreeGridSorting._instance = null;
/** @hidden */
export class IgxTreeGridGroupingPipe {
    transform(collection, groupingExpressions, groupKey, childDataKey, grid, aggregations) {
        if (groupingExpressions.length === 0) {
            return collection;
        }
        if (groupKey?.toLowerCase() === childDataKey?.toLowerCase()) {
            throw new Error('Group key and child data key cannot be the same.');
        }
        this.grid = grid;
        const result = [];
        const groupedRecords = this.groupByMultiple(collection, groupingExpressions);
        this.flattenGrouping(groupedRecords, groupKey, childDataKey, result, aggregations);
        return result;
    }
    flattenGrouping(groupRecords, groupKey, childDataKey, data, aggregations = []) {
        for (const groupRecord of groupRecords) {
            const parent = {};
            const children = groupRecord.records;
            parent[childDataKey] = [];
            for (const aggregation of aggregations) {
                parent[aggregation.field] = aggregation.aggregate(parent, children);
            }
            parent[groupKey] = groupRecord.value + ` (${groupRecord.records.length})`;
            parent[HIDDEN_FIELD_NAME] = { [groupRecord.key]: groupRecord.value };
            data.push(parent);
            if (groupRecord.groups) {
                this.flattenGrouping(groupRecord.groups, groupKey, childDataKey, parent[childDataKey], aggregations);
            }
            else {
                parent[childDataKey] = children;
            }
        }
    }
    groupByMultiple(array, groupingExpressions, index = 0) {
        const res = this.groupBy(array, groupingExpressions[index]);
        if (index + 1 < groupingExpressions.length) {
            for (const groupByRecord of res) {
                groupByRecord.groups = this.groupByMultiple(groupByRecord.records, groupingExpressions, index + 1);
            }
        }
        return res;
    }
    groupBy(array, groupingExpression) {
        const key = groupingExpression.fieldName;
        const column = this.grid?.getColumnByName(key);
        const isDateTime = column?.dataType === GridColumnDataType.Date ||
            column?.dataType === GridColumnDataType.DateTime ||
            column?.dataType === GridColumnDataType.Time;
        const map = new Map();
        for (const record of array) {
            const value = isDateTime
                ? formatDate(record[key], column.pipeArgs.format, this.grid.locale)
                : record[key];
            let valueCase = value;
            let groupByRecord;
            if (groupingExpression.ignoreCase) {
                valueCase = value?.toString().toLowerCase();
            }
            if (map.has(valueCase)) {
                groupByRecord = map.get(valueCase);
            }
            else {
                groupByRecord = new GroupByRecord();
                groupByRecord.key = key;
                groupByRecord.value = value;
                groupByRecord.records = [];
                map.set(valueCase, groupByRecord);
            }
            groupByRecord.records.push(record);
        }
        return Array.from(map.values());
    }
}
IgxTreeGridGroupingPipe.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: IgxTreeGridGroupingPipe, deps: [], target: i0.ɵɵFactoryTarget.Pipe });
IgxTreeGridGroupingPipe.ɵpipe = i0.ɵɵngDeclarePipe({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: IgxTreeGridGroupingPipe, name: "treeGridGrouping" });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: IgxTreeGridGroupingPipe, decorators: [{
            type: Pipe,
            args: [{
                    name: 'treeGridGrouping'
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJlZS1ncmlkLmdyb3VwaW5nLnBpcGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZ3JpZHMvdHJlZS1ncmlkL3RyZWUtZ3JpZC5ncm91cGluZy5waXBlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxJQUFJLEVBQWlCLE1BQU0sZUFBZSxDQUFDO0FBQ3BELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUdyRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7O0FBRWhELE1BQU0saUJBQWlCLEdBQUcsbUJBQW1CLENBQUM7QUFFOUM7OztHQUdHO0FBQ0gsTUFBTSxhQUFhO0NBS2xCO0FBRUQsTUFBTSxPQUFPLG9CQUFvQjtDQUdoQztBQUVELE1BQU0sT0FBTyx5QkFBMEIsU0FBUSxVQUFVO0lBRzlDLE1BQU0sQ0FBQyxRQUFRO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLFNBQVMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSx5QkFBeUIsRUFBRSxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVTLGFBQWEsQ0FBQyxHQUFRLEVBQUUsR0FBVyxFQUFFLFNBQWtCLEtBQUssRUFBRSxTQUFrQixLQUFLO1FBQzNGLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLEdBQUcsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQzFCLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDVixHQUFHLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztZQUNqQyxHQUFHLENBQUMsSUFBSSxDQUFD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YUFBYSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7Z0JBQzVCLGFBQWEsQ0FBQyxPQUFPLEdBQUcsRUFBRSxDQUFDO2dCQUMzQixHQUFHLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQzthQUNyQztZQUVELGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ3RDO1FBRUQsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7O29IQXBHUSx1QkFBdUI7a0hBQXZCLHVCQUF1QjsyRkFBdkIsdUJBQXVCO2tCQUhuQyxJQUFJO21CQUFDO29CQUNGLElBQUksRUFBRSxrQkFBa0I7aUJBQzNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGlwZSwgUGlwZVRyYW5zZm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZm9ybWF0RGF0ZSB9IGZyb20gJy4uLy4uL2NvcmUvdXRpbHMnO1xuaW1wb3J0IHsgR3JpZENvbHVtbkRhdGFUeXBlIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2RhdGEtdXRpbCc7XG5pbXBvcnQgeyBJR3JvdXBpbmdFeHByZXNzaW9uIH0gZnJvbSAnLi4vLi4vZGF0YS1vcGVyYXRpb25zL2dyb3VwaW5nLWV4cHJlc3Npb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IEdyaWRUeXBlIH0gZnJvbSAnLi4vY29tbW9uL2dyaWQuaW50ZXJmYWNlJztcbmltcG9ydCB7IElneFNvcnRpbmcgfSBmcm9tICcuLi9jb21tb24vc3RyYXRlZ3knO1xuXG5jb25zdCBISURERU5fRklFTERfTkFNRSA9ICdfSWd4X0hpZGRlbl9EYXRhXyc7XG5cbi8qKlxuICogQGhpZGRlblxuICogQGludGVybmFsXG4gKi9cbmNsYXNzIEdyb3VwQnlSZWNvcmQge1xuICAgIHB1YmxpYyBrZXk6IHN0cmluZztcbiAgICBwdWJsaWMgdmFsdWU6IGFueTtcbiAgICBwdWJsaWMgZ3JvdXBzOiBHcm91cEJ5UmVjb3JkW107XG4gICAgcHVibGljIHJlY29yZHM6IGFueVtdO1xufVxuXG5leHBvcnQgY2xhc3MgSVRyZWVHcmlkQWdncmVnYXRpb24ge1xuICAgIHB1YmxpYyBmaWVsZDogc3RyaW5nO1xuICAgIHB1YmxpYyBhZ2dyZWdhdGU6IChwYXJlbnQ6IGFueSwgY2hpbGRyZW46IGFueVtdKSA9PiBhbnk7XG59XG5cbmV4cG9ydCBjbGFzcyBJZ3hHcm91cGVkVHJlZUdyaWRTb3J0aW5nIGV4dGVuZHMgSWd4U29ydGluZyB7XG4gICAgcHJpdmF0ZSBzdGF0aWMgX2luc3RhbmNlOiBJZ3hHcm91cGVkVHJlZUdyaWRTb3J0aW5nID0gbnVsbDtcblxuICAgIHB1YmxpYyBzdGF0aWMgaW5zdGFuY2UoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pbnN0YW5jZSB8fCAodGhpcy5faW5zdGFuY2UgPSBuZXcgSWd4R3JvdXBlZFRyZWVHcmlkU29ydGluZygpKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgZ2V0RmllbGRWYWx1ZShvYmo6IGFueSwga2V5OiBzdHJpbmcsIGlzRGF0ZTogYm9vbGVhbiA9IGZhbHNlLCBpc1RpbWU6IGJvb2xlYW4gPSBmYWxzZSk6IGFueSB7XG4gICAgICAgIGNvbnN0IGRhdGEgPSBvYmouZGF0YVtISURERU5fRklFTERfTkFNRV0gP1xuICAgICAgICAgICAgb2JqLmRhdGEuaGFzT3duUHJvcGVydHkoa2V5KSA/XG4gICAgICAgICAgICAgICAgb2JqLmRhdGEgOlxuICAgICAgICAgICAgICAgIG9iai5kYXRhW0hJRERFTl9GSUVMRF9OQU1FXSA6XG4gICAgICAgICAgICBvYmouZGF0YTtcblxuICAgICAgICByZXR1cm4gc3VwZXIuZ2V0RmllbGRWYWx1ZShkYXRhLCBrZXksIGlzRGF0ZSwgaXNUaW1lKTtcbiAgICB9XG59XG5cbi8qKiBAaGlkZGVuICovXG5AUGlwZSh7XG4gICAgbmFtZTogJ3RyZWVHcmlkR3JvdXBpbmcnXG59KVxuZXhwb3J0IGNsYXNzIElneFRyZWVHcmlkR3JvdXBpbmdQaXBlIGltcGxlbWVudHMgUGlwZVRyYW5zZm9ybSB7XG4gICAgcHJpdmF0ZSBncmlkOiBHcmlkVHlwZTtcblxuICAgIHB1YmxpYyB0cmFuc2Zvcm0oY29sbGVjdGlvbjogYW55W10sXG4gICAgICAgICAgICAgICAgICAgICBncm91cGluZ0V4cHJlc3Npb25zOiBJR3JvdXBpbmdFeHByZXNzaW9uW10sXG4gICAgICAgICAgICAgICAgICAgICBncm91cEtleTogc3RyaW5nLFxuICAgICAgICAgICAgICAgICAgICAgY2hpbGREYXRhS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICBncmlkOiBHcmlkVHlwZSxcbiAgICAgICAgICAgICAgICAgICAgIGFnZ3JlZ2F0aW9ucz86IElUcmVlR3JpZEFnZ3JlZ2F0aW9uW11cbiAgICAgICAgICAgICAgICAgICAgKTogYW55W10ge1xuICAgICAgICBpZiAoZ3JvdXBpbmdFeHByZXNzaW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiBjb2xsZWN0aW9uO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGdyb3VwS2V5Py50b0xvd2VyQ2FzZSgpID09PSBjaGlsZERhdGFLZXk/LnRvTG93ZXJDYXNlKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR3JvdXAga2V5IGFuZCBjaGlsZCBkYXRhIGtleSBjYW5ub3QgYmUgdGhlIHNhbWUuJyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmdyaWQgPSBncmlkO1xuXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgICAgICBjb25zdCBncm91cGVkUmVjb3JkcyA9IHRoaXMuZ3JvdXBCeU11bHRpcGxlKGNvbGxlY3Rpb24sIGdyb3VwaW5nRXhwcmVzc2lvbnMpO1xuICAgICAgICB0aGlzLmZsYXR0ZW5Hcm91cGluZyhncm91cGVkUmVjb3JkcywgZ3JvdXBLZXksXG4gICAgICAgICAgICBjaGlsZERhdGFLZXksIHJlc3VsdCwgYWdncmVnYXRpb25zKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIHByaXZhdGUgZmxhdHRlbkdyb3VwaW5nKGdyb3VwUmVjb3JkczogR3JvdXBCeVJlY29yZFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGdyb3VwS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGREYXRhS2V5OiBzdHJpbmcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogYW55W10sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWdncmVnYXRpb25zOiBJVHJlZUdyaWRBZ2dyZWdhdGlvbltdID0gW10pIHtcbiAgICAgICAgZm9yIChjb25zdCBncm91cFJlY29yZCBvZiBncm91cFJlY29yZHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHt9O1xuICAgICAgICAgICAgY29uc3QgY2hpbGRyZW4gPSBncm91cFJlY29yZC5yZWNvcmRzO1xuXG4gICAgICAgICAgICBwYXJlbnRbY2hpbGREYXRhS2V5XSA9IFtdO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IGFnZ3JlZ2F0aW9uIG9mIGFnZ3JlZ2F0aW9ucykge1xuICAgICAgICAgICAgICAgIHBhcmVudFthZ2dyZWdhdGlvbi5maWVsZF0gPSBhZ2dyZWdhdGlvbi5hZ2dyZWdhdGUocGFyZW50LCBjaGlsZHJlbik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHBhcmVudFtncm91cEtleV0gPSBncm91cFJlY29yZC52YWx1ZSArIGAgKCR7Z3JvdXBSZWNvcmQucmVjb3Jkcy5sZW5ndGh9KWA7XG4gICAgICAgICAgICBwYXJlbnRbSElEREVOX0ZJRUxEX05BTUVdID0geyBbZ3JvdXBSZWNvcmQua2V5XTogZ3JvdXBSZWNvcmQudmFsdWUgfTtcbiAgICAgICAgICAgIGRhdGEucHVzaChwYXJlbnQpO1xuXG4gICAgICAgICAgICBpZiAoZ3JvdXBSZWNvcmQuZ3JvdXBzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5mbGF0dGVuR3JvdXBpbmcoZ3JvdXBSZWNvcmQuZ3JvdXBzLCBncm91cEtleSwgY2hpbGREYXRhS2V5LFxuICAgICAgICAgICAgICAgICAgICBwYXJlbnRbY2hpbGREYXRhS2V5XSwgYWdncmVnYXRpb25zKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcGFyZW50W2NoaWxkRGF0YUtleV0gPSBjaGlsZHJlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ3JvdXBCeU11bHRpcGxlKGFycmF5OiBhbnlbXSwgZ3JvdXBpbmdFeHByZXNzaW9uczogSUdyb3VwaW5nRXhwcmVzc2lvbltdLCBpbmRleCA9IDApOiBHcm91cEJ5UmVjb3JkW10ge1xuICAgICAgICBjb25zdCByZXMgPSB0aGlzLmdyb3VwQnkoYXJyYXksIGdyb3VwaW5nRXhwcmVzc2lvbnNbaW5kZXhdKTtcblxuICAgICAgICBpZiAoaW5kZXggKyAxIDwgZ3JvdXBpbmdFeHByZXNzaW9ucy5sZW5ndGgpIHtcbiAgICAgICAgICAgZm9yIChjb25zdCBncm91cEJ5UmVjb3JkIG9mIHJlcykge1xuICAgICAgICAgICAgICAgIGdyb3VwQnlSZWNvcmQuZ3JvdXBzID0gdGhpcy5ncm91cEJ5TXVsdGlwbGUoZ3JvdXBCeVJlY29yZC5yZWNvcmRzLCBncm91cGluZ0V4cHJlc3Npb25zLCBpbmRleCArIDEpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdyb3VwQnkoYXJyYXk6IGFueVtdLCBncm91cGluZ0V4cHJlc3Npb246IElHcm91cGluZ0V4cHJlc3Npb24pOiBHcm91cEJ5UmVjb3JkW10ge1xuICAgICAgICBjb25zdCBrZXkgPSBncm91cGluZ0V4cHJlc3Npb24uZmllbGROYW1lO1xuICAgICAgICBjb25zdCBjb2x1bW4gPSB0aGlzLmdyaWQ/LmdldENvbHVtbkJ5TmFtZShrZXkpO1xuICAgICAgICBjb25zdCBpc0RhdGVUaW1lID0gY29sdW1uPy5kYXRhVHlwZSA9PT0gR3JpZENvbHVtbkRhdGFUeXBlLkRhdGUgfHxcbiAgICAgICAgICAgIGNvbHVtbj8uZGF0YVR5cGUgPT09IEdyaWRDb2x1bW5EYXRhVHlwZS5EYXRlVGltZSB8fFxuICAgICAgICAgICAgY29sdW1uPy5kYXRhVHlwZSA9PT0gR3JpZENvbHVtbkRhdGFUeXBlLlRpbWU7XG4gICAgICAgIGNvbnN0IG1hcDogTWFwPGFueSwgR3JvdXBCeVJlY29yZD4gPSBuZXcgTWFwPGFueSwgR3JvdXBCeVJlY29yZD4oKTtcbiAgICAgICAgZm9yIChjb25zdCByZWNvcmQgb2YgYXJyYXkpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXNEYXRlVGltZVxuICAgICAgICAgICAgICAgID8gZm9ybWF0RGF0ZShyZWNvcmRba2V5XSwgY29sdW1uLnBpcGVBcmdzLmZvcm1hdCwgdGhpcy5ncmlkLmxvY2FsZSlcbiAgICAgICAgICAgICAgICA6IHJlY29yZFtrZXldO1xuXG4gICAgICAgICAgICBsZXQgdmFsdWVDYXNlID0gdmFsdWU7XG4gICAgICAgICAgICBsZXQgZ3JvdXBCeVJlY29yZDogR3JvdXBCeVJlY29yZDtcblxuICAgICAgICAgICAgaWYgKGdyb3VwaW5nRXhwcmVzc2lvbi5pZ25vcmVDYXNlKSB7XG4gICAgICAgICAgICAgICAgdmFsdWVDYXNlID0gdmFsdWU/LnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChtYXAuaGFzKHZhbHVlQ2FzZSkpIHtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkID0gbWFwLmdldCh2YWx1ZUNhc2UpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkID0gbmV3IEdyb3VwQnlSZWNvcmQoKTtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkLmtleSA9IGtleTtcbiAgICAgICAgICAgICAgICBncm91cEJ5UmVjb3JkLnZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgICAgICAgZ3JvdXBCeVJlY29yZC5yZWNvcmRzID0gW107XG4gICAgICAgICAgICAgICAgbWFwLnNldCh2YWx1ZUNhc2UsIGdyb3VwQnlSZWNvcmQpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBncm91cEJ5UmVjb3JkLnJlY29yZHMucHVzaChyZWNvcmQpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIEFycmF5LmZyb20obWFwLnZhbHVlcygpKTtcbiAgICB9XG59XG4iXX0=