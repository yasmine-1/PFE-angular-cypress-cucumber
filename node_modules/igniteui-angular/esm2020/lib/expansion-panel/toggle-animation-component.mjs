import { useAnimation } from '@angular/animations';
import { Directive, EventEmitter } from '@angular/core';
import { noop, Subject } from 'rxjs';
import { growVerIn, growVerOut } from '../animations/grow';
import * as i0 from "@angular/core";
import * as i1 from "@angular/animations";
/** @hidden @internal */
export var ANIMATION_TYPE;
(function (ANIMATION_TYPE) {
    ANIMATION_TYPE["OPEN"] = "open";
    ANIMATION_TYPE["CLOSE"] = "close";
})(ANIMATION_TYPE || (ANIMATION_TYPE = {}));
/**@hidden @internal */
// eslint-disable-next-line @angular-eslint/directive-class-suffix
export class ToggleAnimationPlayer {
    constructor(builder) {
        this.builder = builder;
        /** @hidden @internal */
        this.openAnimationDone = new EventEmitter();
        /** @hidden @internal */
        this.closeAnimationDone = new EventEmitter();
        /** @hidden @internal */
        this.openAnimationStart = new EventEmitter();
        /** @hidden @internal */
        this.closeAnimationStart = new EventEmitter();
        /** @hidden @internal */
        this.openAnimationPlayer = null;
        /** @hidden @internal */
        this.closeAnimationPlayer = null;
        this.destroy$ = new Subject();
        this.players = new Map();
        this._animationSettings = {
            openAnimation: growVerIn,
            closeAnimation: growVerOut
        };
        this.closeInterrupted = false;
        this.openInterrupted = false;
        this._defaultClosedCallback = noop;
        this._defaultOpenedCallback = noop;
        this.onClosedCallback = this._defaultClosedCallback;
        this.onOpenedCallback = this._defaultOpenedCallback;
    }
    get animationSettings() {
        return this._animationSettings;
    }
    set animationSettings(value) {
        this._animationSettings = value;
    }
    /** @hidden @internal */
    playOpenAnimation(targetElement, onDone) {
        this.startPlayer(ANIMATION_TYPE.OPEN, targetElement, onDone || this._defaultOpenedCallback);
    }
    /** @hidden @internal */
    playCloseAnimation(targetElement, onDone) {
        this.startPlayer(ANIMATION_TYPE.CLOSE, targetElement, onDone || this._defaultClosedCallback);
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    startPlayer(type, targetElement, callback) {
        if (!targetElement) { // if no element is passed, there is nothing to animate
            return;
        }
        let target = this.getPlayer(type);
        if (!target) {
            target = this.initializePlayer(type, targetElement, callback);
        }
        // V.S. Jun 28th, 2021 #9783: player will NOT be initialized w/ null settings
        // events will already be emitted
        if (!target || target.hasStarted()) {
            return;
        }
        const targetEmitter = type === ANIMATION_TYPE.OPEN ? this.openAnimationStart : this.closeAnimationStart;
        targetEmitter.emit();
        if (target) {
            target.play();
        }
    }
    initializePlayer(type, targetElement, callback) {
        const oppositeType = type === ANIMATION_TYPE.OPEN ? ANIMATION_TYPE.CLOSE : ANIMATION_TYPE.OPEN;
        // V.S. Jun 28th, 2021 #9783: Treat falsy animation settings as disabled animations
        const targetAnimationSettings = this.animationSettings || { closeAnimation: null, openAnimation: null };
        const animationSettings = type === ANIMATION_TYPE.OPEN ?
            targetAnimationSettings.openAnimation : targetAnimationSettings.closeAnimation;
        // V.S. Jun 28th, 2021 #9783: When no animation in target direction, emit start and done events and return
        if (!animationSettings) {
            this.setCallback(type, callback);
            const targetEmitter = type === ANIMATION_TYPE.OPEN ? this.openAnimationStart : this.closeAnimationStart;
            targetEmitter.emit();
            this.onDoneHandler(type);
            return;
        }
        const animation = useAnimation(animationSettings);
        const animationBuilder = this.builder.build(animation);
        const opposite = this.getPlayer(oppositeType);
        let oppositePosition = 1;
        if (opposite) {
            if (opposite.hasStarted()) {
                // .getPosition() still returns 0 sometimes, regardless of the fix for https://github.com/angular/angular/issues/18891;
                const renderer = opposite._renderer;
                oppositePosition = renderer.engine.players[renderer.engine.players.length - 1].getPosition();
            }
            this.cleanUpPlayer(oppositeType);
        }
        if (type === ANIMATION_TYPE.OPEN) {
            this.openAnimationPlayer = animationBuilder.create(targetElement.nativeElement);
        }
        else if (type === ANIMATION_TYPE.CLOSE) {
            this.closeAnimationPlayer = animationBuilder.create(targetElement.nativeElement);
        }
        const target = this.getPlayer(type);
        target.init();
        this.getPlayer(type).setPosition(1 - oppositePosition);
        this.setCallback(type, callback);
        target.onDone(() => {
            this.onDoneHandler(type);
        });
        return target;
    }
    onDoneHandler(type) {
        const targetEmitter = type === ANIMATION_TYPE.OPEN ? this.openAnimationDone : this.closeAnimationDone;
        const targetCallback = type === ANIMATION_TYPE.OPEN ? this.onOpenedCallback : this.onClosedCallback;
        targetCallback();
        if (!(type === ANIMATION_TYPE.OPEN ? this.openInterrupted : this.closeInterrupted)) {
            targetEmitter.emit();
        }
        this.cleanUpPlayer(type);
    }
    setCallback(type, callback) {
        if (type === ANIMATION_TYPE.OPEN) {
            this.onOpenedCallback = callback;
            this.openInterrupted = false;
        }
        else if (type === ANIMATION_TYPE.CLOSE) {
            this.onClosedCallback = callback;
            this.closeInterrupted = false;
        }
    }
    cleanUpPlayer(target) {
        switch (target) {
            case ANIMATION_TYPE.CLOSE:
                if (this.closeAnimationPlayer != null) {
                    this.closeAnimationPlayer.reset();
                    this.closeAnimationPlayer.destroy();
                    this.closeAnimationPlayer = null;
                }
                this.closeInterrupted = true;
                this.onClosedCallback = this._defaultClosedCallback;
                break;
            case ANIMATION_TYPE.OPEN:
                if (this.openAnimationPlayer != null) {
                    this.openAnimationPlayer.reset();
                    this.openAnimationPlayer.destroy();
                    this.openAnimationPlayer = null;
                }
                this.openInterrupted = true;
                this.onOpenedCallback = this._defaultOpenedCallback;
                break;
            default:
                break;
        }
    }
    getPlayer(type) {
        switch (type) {
            case ANIMATION_TYPE.OPEN:
                return this.openAnimationPlayer;
            case ANIMATION_TYPE.CLOSE:
                return this.closeAnimationPlayer;
            default:
                return null;
        }
    }
}
ToggleAnimationPlayer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: ToggleAnimationPlayer, deps: [{ token: i1.AnimationBuilder }], target: i0.ɵɵFactoryTarget.Directive });
ToggleAnimationPlayer.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.2.2", type: ToggleAnimationPlayer, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.2.2", ngImport: i0, type: ToggleAnimationPlayer, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i1.AnimationBuilder }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9nZ2xlLWFuaW1hdGlvbi1jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9pZ25pdGV1aS1hbmd1bGFyL3NyYy9saWIvZXhwYW5zaW9uLXBhbmVsL3RvZ2dsZS1hbmltYXRpb24tY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBaUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEgsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFDL0UsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDckMsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQzs7O0FBb0IzRCx3QkFBd0I7QUFDeEIsTUFBTSxDQUFOLElBQVksY0FHWDtBQUhELFdBQVksY0FBYztJQUN0QiwrQkFBYSxDQUFBO0lBQ2IsaUNBQWUsQ0FBQTtBQUNuQixDQUFDLEVBSFcsY0FBYyxLQUFkLGNBQWMsUUFHekI7QUFFRCx1QkFBdUI7QUFFdkIsa0VBQWtFO0FBQ2xFLE1BQU0sT0FBZ0IscUJBQXFCO0lBMEN2QyxZQUFzQixPQUF5QjtRQUF6QixZQUFPLEdBQVAsT0FBTyxDQUFrQjtRQXZDL0Msd0JBQXdCO1FBQ2pCLHNCQUFpQixHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ2xFLHdCQUF3QjtRQUNqQix1QkFBa0IsR0FBdUIsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUNuRSx3QkFBd0I7UUFDakIsdUJBQWtCLEdBQXVCLElBQUksWUFBWSxFQUFFLENBQUM7UUFDbkUsd0JBQXdCO1FBQ2pCLHdCQUFtQixHQUF1QixJQUFJLFlBQVksRUFBRSxDQUFDO1FBU3BFLHdCQUF3QjtRQUNqQix3QkFBbUIsR0FBb0IsSUFBSSxDQUFDO1FBRW5ELHdCQUF3QjtRQUNqQix5QkFBb0IsR0FBb0IsSUFBSSxDQUFDO1FBSTFDLGFBQVEsR0FBa0IsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN4QyxZQUFPLEdBQWlDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDbEQsdUJBQWtCLEdBQTRCO1lBQ3BELGFBQWEsRUFBRSxTQUFTO1lBQ3hCLGNBQWMsRUFBRSxVQUFVO1NBQzdCLENBQUM7UUFFTSxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFDekIsb0JBQWUsR0FBRyxLQUFLLENBQUM7UUFFeEIsMkJBQXNCLEdBQUcsSUFBSSxDQUFDO1FBQzlCLDJCQUFzQixHQUFHLElBQUksQ0FBQztRQUM5QixxQkFBZ0IsR0FBYyxJQUFJLENBQUMsc0JBQXNCLENBQUM7UUFDMUQscUJBQWdCLEdBQWMsSUFBSSxDQUFDLHNCQUFzQixDQUFDO0lBR2xFLENBQUM7SUEvQkQsSUFBVyxpQkFBaUI7UUFDeEIsT0FBTyxJQUFJLENBQUMsa0JBQWtCLENBQUM7SUFDbkMsQ0FBQztJQUNELElBQVcsaUJBQWlCLENBQUMsS0FBOEI7UUFDdkQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLEtBQUssQ0FBQztJQUNwQyxDQUFDO0lBNEJELHdCQUF3QjtJQUNqQixpQkFBaUIsQ0FBQyxhQUF5QixFQUFFLE1BQW1CO1FBQ25FLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsTUFBTSxJQUFJLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ2hHLENBQUM7SUFFRCx3QkFBd0I7SUFDakIsa0JBQWtCLENBQUMsYUFBeUIsRUFBRSxNQUFtQjtRQUNwRSxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsYUFBYSxFQUFFLE1BQU0sSUFBSSxJQUFJLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNqRyxDQUFDO0lBQ00sV0FBVztRQUNkLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lBRU8sV0FBVyxDQUFDLElBQW9CLEVBQUUsYUFBeUIsRUFBRSxRQUFvQjtRQUNyRixJQUFJLENBQUMsYUFBYSxFQUFFLEVBQUUsdURBQXVEO1lBQ3pFLE9BQU87U0FDVjtRQUVELElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDbEMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUNULE1BQU0sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxFQUFFLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNqRTtRQUVELDZFQUE2RTtRQUM3RSxpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxFQUFFLEVBQUU7WUFDaEMsT0FBTztTQUNWO1FBRUQsTUFBTSxhQUFhLEdBQUcsSUFBSSxLQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDO1FBQ3hHLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQixJQUFJLE1BQU0sRUFBRTtZQUNSLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztTQUNqQjtJQUNMLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxJQUFvQixFQUFFLGFBQXlCLEVBQUUsUUFBb0I7UUFDMUYsTUFBTSxZQUFZLEdBQUcsSUFBSSxLQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUM7UUFDL0YsbUZBQW1GO1FBQ25GLE1BQU0sdUJBQXVCLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixJQUFJLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsSUFBSSxFQUFFLENBQUM7UUFDeEcsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLEtBQUssY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BELHVCQUF1QixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLENBQUMsY0FBYyxDQUFDO1FBQ25GLDBHQUEwRztRQUMxRyxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDcEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDakMsTUFBTSxhQUFhLEdBQUcsSUFBSSxLQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDO1lBQ3hHLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pCLE9BQU87U0FDVjtRQUNELE1BQU0sU0FBUyxHQUFHLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUM5QyxJQUFJLGdCQUFnQixHQUFHLENBQUMsQ0FBQztRQUN6QixJQUFJLFFBQVEsRUFBRTtZQUNWLElBQUksUUFBUSxDQUFDLFVBQVUsRUFBRSxFQUFFO2dCQUN2Qix1SEFBdUg7Z0JBQ3ZILE1BQU0sUUFBUSxHQUFJLFFBQWdCLENBQUMsU0FBUyxDQUFDO2dCQUM3QyxnQkFBZ0IsR0FBRyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7YUFDaEc7WUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1NBQ3BDO1FBQ0QsSUFBSSxJQUFJLEtBQUssY0FBYyxDQUFDLElBQUksRUFBRTtZQUM5QixJQUFJLENBQUMsbUJBQW1CLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztTQUNuRjthQUFNLElBQUksSUFBSSxLQUFLLGNBQWMsQ0FBQyxLQUFLLEVBQUU7WUFDdEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDcEY7UUFDRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNkLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsR0FBRyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3ZELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM3QixDQUFDLENBQUMsQ0FBQztRQUNILE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxhQUFhLENBQUMsSUFBSTtRQUN0QixNQUFNLGFBQWEsR0FBRyxJQUFJLEtBQUssY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUM7UUFDdEcsTUFBTSxjQUFjLEdBQUcsSUFBSSxLQUFLLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQ3BHLGNBQWMsRUFBRSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxDQUFDLElBQUksS0FBSyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRTtZQUNoRixhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDeEI7UUFDRCxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTyxXQUFXLENBQUMsSUFBb0IsRUFBRSxRQUFvQjtRQUMxRCxJQUFJLElBQUksS0FBSyxjQUFjLENBQUMsSUFBSSxFQUFFO1lBQzlCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUM7WUFDakMsSUFBSSxDQUFDLGVBQWUsR0FBRyxLQUFLLENBQUM7U0FDaEM7YUFBTSxJQUFJLElBQUksS0FBSyxjQUFjLENBQUMsS0FBSyxFQUFFO1lBQ3RDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxRQUFRLENBQUM7WUFDakMsSUFBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQztTQUNqQztJQUNMLENBQUM7SUFHTyxhQUFhLENBQUMsTUFBc0I7UUFDeEMsUUFBUSxNQUFNLEVBQUU7WUFDWixLQUFLLGNBQWMsQ0FBQyxLQUFLO2dCQUNyQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLEVBQUU7b0JBQ25DLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDbEMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxDQUFDO29CQUNwQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO2lCQUNwQztnQkFDRCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO2dCQUM3QixJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLHNCQUFzQixDQUFDO2dCQUNwRCxNQUFNO1lBQ1YsS0FBSyxjQUFjLENBQUMsSUFBSTtnQkFDcEIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLElBQUksSUFBSSxFQUFFO29CQUNsQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsS0FBSyxFQUFFLENBQUM7b0JBQ2pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztvQkFDbkMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksQ0FBQztpQkFDbkM7Z0JBQ0QsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7Z0JBQzVCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsc0JBQXNCLENBQUM7Z0JBQ3BELE1BQU07WUFDVjtnQkFDSSxNQUFNO1NBQ2I7SUFDTCxDQUFDO0lBRU8sU0FBUyxDQUFDLElBQW9CO1FBQ2xDLFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxjQUFjLENBQUMsSUFBSTtnQkFDcEIsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUM7WUFDcEMsS0FBSyxjQUFjLENBQUMsS0FBSztnQkFDckIsT0FBTyxJQUFJLENBQUMsb0JBQW9CLENBQUM7WUFDckM7Z0JBQ0ksT0FBTyxJQUFJLENBQUM7U0FDbkI7SUFDTCxDQUFDOztrSEFuTGlCLHFCQUFxQjtzR0FBckIscUJBQXFCOzJGQUFyQixxQkFBcUI7a0JBRjFDLFNBQVMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBbmltYXRpb25CdWlsZGVyLCBBbmltYXRpb25QbGF5ZXIsIEFuaW1hdGlvblJlZmVyZW5jZU1ldGFkYXRhLCB1c2VBbmltYXRpb24gfSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcbmltcG9ydCB7IERpcmVjdGl2ZSwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG5vb3AsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGdyb3dWZXJJbiwgZ3Jvd1Zlck91dCB9IGZyb20gJy4uL2FuaW1hdGlvbnMvZ3Jvdyc7XG5cbi8qKkBoaWRkZW4gQGludGVybmFsICovXG5leHBvcnQgaW50ZXJmYWNlIFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzIHtcbiAgICBvcGVuQW5pbWF0aW9uOiBBbmltYXRpb25SZWZlcmVuY2VNZXRhZGF0YTtcbiAgICBjbG9zZUFuaW1hdGlvbjogQW5pbWF0aW9uUmVmZXJlbmNlTWV0YWRhdGE7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVG9nZ2xlQW5pbWF0aW9uT3duZXIge1xuICAgIGFuaW1hdGlvblNldHRpbmdzOiBUb2dnbGVBbmltYXRpb25TZXR0aW5ncztcbiAgICBvcGVuQW5pbWF0aW9uU3RhcnQ6IEV2ZW50RW1pdHRlcjx2b2lkPjtcbiAgICBvcGVuQW5pbWF0aW9uRG9uZTogRXZlbnRFbWl0dGVyPHZvaWQ+O1xuICAgIGNsb3NlQW5pbWF0aW9uU3RhcnQ6IEV2ZW50RW1pdHRlcjx2b2lkPjtcbiAgICBjbG9zZUFuaW1hdGlvbkRvbmU6IEV2ZW50RW1pdHRlcjx2b2lkPjtcbiAgICBvcGVuQW5pbWF0aW9uUGxheWVyOiBBbmltYXRpb25QbGF5ZXI7XG4gICAgY2xvc2VBbmltYXRpb25QbGF5ZXI6IEFuaW1hdGlvblBsYXllcjtcbiAgICBwbGF5T3BlbkFuaW1hdGlvbihlbGVtZW50OiBFbGVtZW50UmVmLCBvbkRvbmU6ICgpID0+IHZvaWQpOiB2b2lkO1xuICAgIHBsYXlDbG9zZUFuaW1hdGlvbihlbGVtZW50OiBFbGVtZW50UmVmLCBvbkRvbmU6ICgpID0+IHZvaWQpOiB2b2lkO1xufVxuXG4vKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbmV4cG9ydCBlbnVtIEFOSU1BVElPTl9UWVBFIHtcbiAgICBPUEVOID0gJ29wZW4nLFxuICAgIENMT1NFID0gJ2Nsb3NlJyxcbn1cblxuLyoqQGhpZGRlbiBAaW50ZXJuYWwgKi9cbkBEaXJlY3RpdmUoKVxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBhbmd1bGFyLWVzbGludC9kaXJlY3RpdmUtY2xhc3Mtc3VmZml4XG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVG9nZ2xlQW5pbWF0aW9uUGxheWVyIGltcGxlbWVudHMgVG9nZ2xlQW5pbWF0aW9uT3duZXIsIE9uRGVzdHJveSB7XG5cblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBvcGVuQW5pbWF0aW9uRG9uZTogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBjbG9zZUFuaW1hdGlvbkRvbmU6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbiAgICBwdWJsaWMgb3BlbkFuaW1hdGlvblN0YXJ0OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXG4gICAgcHVibGljIGNsb3NlQW5pbWF0aW9uU3RhcnQ6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcblxuICAgIHB1YmxpYyBnZXQgYW5pbWF0aW9uU2V0dGluZ3MoKTogVG9nZ2xlQW5pbWF0aW9uU2V0dGluZ3Mge1xuICAgICAgICByZXR1cm4gdGhpcy5fYW5pbWF0aW9uU2V0dGluZ3M7XG4gICAgfVxuICAgIHB1YmxpYyBzZXQgYW5pbWF0aW9uU2V0dGluZ3ModmFsdWU6IFRvZ2dsZUFuaW1hdGlvblNldHRpbmdzKSB7XG4gICAgICAgIHRoaXMuX2FuaW1hdGlvblNldHRpbmdzID0gdmFsdWU7XG4gICAgfVxuXG4gICAgLyoqIEBoaWRkZW4gQGludGVybmFsICovXG4gICAgcHVibGljIG9wZW5BbmltYXRpb25QbGF5ZXI6IEFuaW1hdGlvblBsYXllciA9IG51bGw7XG5cbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbiAgICBwdWJsaWMgY2xvc2VBbmltYXRpb25QbGF5ZXI6IEFuaW1hdGlvblBsYXllciA9IG51bGw7XG5cblxuXG4gICAgcHJvdGVjdGVkIGRlc3Ryb3kkOiBTdWJqZWN0PHZvaWQ+ID0gbmV3IFN1YmplY3QoKTtcbiAgICBwcm90ZWN0ZWQgcGxheWVyczogTWFwPHN0cmluZywgQW5pbWF0aW9uUGxheWVyPiA9IG5ldyBNYXAoKTtcbiAgICBwcm90ZWN0ZWQgX2FuaW1hdGlvblNldHRpbmdzOiBUb2dnbGVBbmltYXRpb25TZXR0aW5ncyA9IHtcbiAgICAgICAgb3BlbkFuaW1hdGlvbjogZ3Jvd1ZlckluLFxuICAgICAgICBjbG9zZUFuaW1hdGlvbjogZ3Jvd1Zlck91dFxuICAgIH07XG5cbiAgICBwcml2YXRlIGNsb3NlSW50ZXJydXB0ZWQgPSBmYWxzZTtcbiAgICBwcml2YXRlIG9wZW5JbnRlcnJ1cHRlZCA9IGZhbHNlO1xuXG4gICAgcHJpdmF0ZSBfZGVmYXVsdENsb3NlZENhbGxiYWNrID0gbm9vcDtcbiAgICBwcml2YXRlIF9kZWZhdWx0T3BlbmVkQ2FsbGJhY2sgPSBub29wO1xuICAgIHByaXZhdGUgb25DbG9zZWRDYWxsYmFjazogKCkgPT4gYW55ID0gdGhpcy5fZGVmYXVsdENsb3NlZENhbGxiYWNrO1xuICAgIHByaXZhdGUgb25PcGVuZWRDYWxsYmFjazogKCkgPT4gYW55ID0gdGhpcy5fZGVmYXVsdE9wZW5lZENhbGxiYWNrO1xuXG4gICAgY29uc3RydWN0b3IocHJvdGVjdGVkIGJ1aWxkZXI6IEFuaW1hdGlvbkJ1aWxkZXIpIHtcbiAgICB9XG5cbiAgICAvKiogQGhpZGRlbiBAaW50ZXJuYWwgKi9cbiAgICBwdWJsaWMgcGxheU9wZW5BbmltYXRpb24odGFyZ2V0RWxlbWVudDogRWxlbWVudFJlZiwgb25Eb25lPzogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0YXJ0UGxheWVyKEFOSU1BVElPTl9UWVBFLk9QRU4sIHRhcmdldEVsZW1lbnQsIG9uRG9uZSB8fCB0aGlzLl9kZWZhdWx0T3BlbmVkQ2FsbGJhY2spO1xuICAgIH1cblxuICAgIC8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuICAgIHB1YmxpYyBwbGF5Q2xvc2VBbmltYXRpb24odGFyZ2V0RWxlbWVudDogRWxlbWVudFJlZiwgb25Eb25lPzogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0YXJ0UGxheWVyKEFOSU1BVElPTl9UWVBFLkNMT1NFLCB0YXJnZXRFbGVtZW50LCBvbkRvbmUgfHwgdGhpcy5fZGVmYXVsdENsb3NlZENhbGxiYWNrKTtcbiAgICB9XG4gICAgcHVibGljIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICAgICAgdGhpcy5kZXN0cm95JC5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRQbGF5ZXIodHlwZTogQU5JTUFUSU9OX1RZUEUsIHRhcmdldEVsZW1lbnQ6IEVsZW1lbnRSZWYsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgICAgIGlmICghdGFyZ2V0RWxlbWVudCkgeyAvLyBpZiBubyBlbGVtZW50IGlzIHBhc3NlZCwgdGhlcmUgaXMgbm90aGluZyB0byBhbmltYXRlXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgdGFyZ2V0ID0gdGhpcy5nZXRQbGF5ZXIodHlwZSk7XG4gICAgICAgIGlmICghdGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXQgPSB0aGlzLmluaXRpYWxpemVQbGF5ZXIodHlwZSwgdGFyZ2V0RWxlbWVudCwgY2FsbGJhY2spO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVi5TLiBKdW4gMjh0aCwgMjAyMSAjOTc4MzogcGxheWVyIHdpbGwgTk9UIGJlIGluaXRpYWxpemVkIHcvIG51bGwgc2V0dGluZ3NcbiAgICAgICAgLy8gZXZlbnRzIHdpbGwgYWxyZWFkeSBiZSBlbWl0dGVkXG4gICAgICAgIGlmICghdGFyZ2V0IHx8IHRhcmdldC5oYXNTdGFydGVkKCkpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRhcmdldEVtaXR0ZXIgPSB0eXBlID09PSBBTklNQVRJT05fVFlQRS5PUEVOID8gdGhpcy5vcGVuQW5pbWF0aW9uU3RhcnQgOiB0aGlzLmNsb3NlQW5pbWF0aW9uU3RhcnQ7XG4gICAgICAgIHRhcmdldEVtaXR0ZXIuZW1pdCgpO1xuICAgICAgICBpZiAodGFyZ2V0KSB7XG4gICAgICAgICAgICB0YXJnZXQucGxheSgpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBpbml0aWFsaXplUGxheWVyKHR5cGU6IEFOSU1BVElPTl9UWVBFLCB0YXJnZXRFbGVtZW50OiBFbGVtZW50UmVmLCBjYWxsYmFjazogKCkgPT4gdm9pZCk6IEFuaW1hdGlvblBsYXllciB7XG4gICAgICAgIGNvbnN0IG9wcG9zaXRlVHlwZSA9IHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4gPyBBTklNQVRJT05fVFlQRS5DTE9TRSA6IEFOSU1BVElPTl9UWVBFLk9QRU47XG4gICAgICAgIC8vIFYuUy4gSnVuIDI4dGgsIDIwMjEgIzk3ODM6IFRyZWF0IGZhbHN5IGFuaW1hdGlvbiBzZXR0aW5ncyBhcyBkaXNhYmxlZCBhbmltYXRpb25zXG4gICAgICAgIGNvbnN0IHRhcmdldEFuaW1hdGlvblNldHRpbmdzID0gdGhpcy5hbmltYXRpb25TZXR0aW5ncyB8fCB7IGNsb3NlQW5pbWF0aW9uOiBudWxsLCBvcGVuQW5pbWF0aW9uOiBudWxsIH07XG4gICAgICAgIGNvbnN0IGFuaW1hdGlvblNldHRpbmdzID0gdHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/XG4gICAgICAgICAgICB0YXJnZXRBbmltYXRpb25TZXR0aW5ncy5vcGVuQW5pbWF0aW9uIDogdGFyZ2V0QW5pbWF0aW9uU2V0dGluZ3MuY2xvc2VBbmltYXRpb247XG4gICAgICAgIC8vIFYuUy4gSnVuIDI4dGgsIDIwMjEgIzk3ODM6IFdoZW4gbm8gYW5pbWF0aW9uIGluIHRhcmdldCBkaXJlY3Rpb24sIGVtaXQgc3RhcnQgYW5kIGRvbmUgZXZlbnRzIGFuZCByZXR1cm5cbiAgICAgICAgaWYgKCFhbmltYXRpb25TZXR0aW5ncykge1xuICAgICAgICAgICAgdGhpcy5zZXRDYWxsYmFjayh0eXBlLCBjYWxsYmFjayk7XG4gICAgICAgICAgICBjb25zdCB0YXJnZXRFbWl0dGVyID0gdHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/IHRoaXMub3BlbkFuaW1hdGlvblN0YXJ0IDogdGhpcy5jbG9zZUFuaW1hdGlvblN0YXJ0O1xuICAgICAgICAgICAgdGFyZ2V0RW1pdHRlci5lbWl0KCk7XG4gICAgICAgICAgICB0aGlzLm9uRG9uZUhhbmRsZXIodHlwZSk7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYW5pbWF0aW9uID0gdXNlQW5pbWF0aW9uKGFuaW1hdGlvblNldHRpbmdzKTtcbiAgICAgICAgY29uc3QgYW5pbWF0aW9uQnVpbGRlciA9IHRoaXMuYnVpbGRlci5idWlsZChhbmltYXRpb24pO1xuICAgICAgICBjb25zdCBvcHBvc2l0ZSA9IHRoaXMuZ2V0UGxheWVyKG9wcG9zaXRlVHlwZSk7XG4gICAgICAgIGxldCBvcHBvc2l0ZVBvc2l0aW9uID0gMTtcbiAgICAgICAgaWYgKG9wcG9zaXRlKSB7XG4gICAgICAgICAgICBpZiAob3Bwb3NpdGUuaGFzU3RhcnRlZCgpKSB7XG4gICAgICAgICAgICAgICAgLy8gLmdldFBvc2l0aW9uKCkgc3RpbGwgcmV0dXJucyAwIHNvbWV0aW1lcywgcmVnYXJkbGVzcyBvZiB0aGUgZml4IGZvciBodHRwczovL2dpdGh1Yi5jb20vYW5ndWxhci9hbmd1bGFyL2lzc3Vlcy8xODg5MTtcbiAgICAgICAgICAgICAgICBjb25zdCByZW5kZXJlciA9IChvcHBvc2l0ZSBhcyBhbnkpLl9yZW5kZXJlcjtcbiAgICAgICAgICAgICAgICBvcHBvc2l0ZVBvc2l0aW9uID0gcmVuZGVyZXIuZW5naW5lLnBsYXllcnNbcmVuZGVyZXIuZW5naW5lLnBsYXllcnMubGVuZ3RoIC0gMV0uZ2V0UG9zaXRpb24oKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jbGVhblVwUGxheWVyKG9wcG9zaXRlVHlwZSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4pIHtcbiAgICAgICAgICAgIHRoaXMub3BlbkFuaW1hdGlvblBsYXllciA9IGFuaW1hdGlvbkJ1aWxkZXIuY3JlYXRlKHRhcmdldEVsZW1lbnQubmF0aXZlRWxlbWVudCk7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuQ0xPU0UpIHtcbiAgICAgICAgICAgIHRoaXMuY2xvc2VBbmltYXRpb25QbGF5ZXIgPSBhbmltYXRpb25CdWlsZGVyLmNyZWF0ZSh0YXJnZXRFbGVtZW50Lm5hdGl2ZUVsZW1lbnQpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHRhcmdldCA9IHRoaXMuZ2V0UGxheWVyKHR5cGUpO1xuICAgICAgICB0YXJnZXQuaW5pdCgpO1xuICAgICAgICB0aGlzLmdldFBsYXllcih0eXBlKS5zZXRQb3NpdGlvbigxIC0gb3Bwb3NpdGVQb3NpdGlvbik7XG4gICAgICAgIHRoaXMuc2V0Q2FsbGJhY2sodHlwZSwgY2FsbGJhY2spO1xuICAgICAgICB0YXJnZXQub25Eb25lKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMub25Eb25lSGFuZGxlcih0eXBlKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0YXJnZXQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvbkRvbmVIYW5kbGVyKHR5cGUpIHtcbiAgICAgICAgY29uc3QgdGFyZ2V0RW1pdHRlciA9IHR5cGUgPT09IEFOSU1BVElPTl9UWVBFLk9QRU4gPyB0aGlzLm9wZW5BbmltYXRpb25Eb25lIDogdGhpcy5jbG9zZUFuaW1hdGlvbkRvbmU7XG4gICAgICAgIGNvbnN0IHRhcmdldENhbGxiYWNrID0gdHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/IHRoaXMub25PcGVuZWRDYWxsYmFjayA6IHRoaXMub25DbG9zZWRDYWxsYmFjaztcbiAgICAgICAgdGFyZ2V0Q2FsbGJhY2soKTtcbiAgICAgICAgaWYgKCEodHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuT1BFTiA/IHRoaXMub3BlbkludGVycnVwdGVkIDogdGhpcy5jbG9zZUludGVycnVwdGVkKSkge1xuICAgICAgICAgICAgdGFyZ2V0RW1pdHRlci5lbWl0KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jbGVhblVwUGxheWVyKHR5cGUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0Q2FsbGJhY2sodHlwZTogQU5JTUFUSU9OX1RZUEUsIGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XG4gICAgICAgIGlmICh0eXBlID09PSBBTklNQVRJT05fVFlQRS5PUEVOKSB7XG4gICAgICAgICAgICB0aGlzLm9uT3BlbmVkQ2FsbGJhY2sgPSBjYWxsYmFjaztcbiAgICAgICAgICAgIHRoaXMub3BlbkludGVycnVwdGVkID0gZmFsc2U7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZSA9PT0gQU5JTUFUSU9OX1RZUEUuQ0xPU0UpIHtcbiAgICAgICAgICAgIHRoaXMub25DbG9zZWRDYWxsYmFjayA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgdGhpcy5jbG9zZUludGVycnVwdGVkID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cblxuICAgIHByaXZhdGUgY2xlYW5VcFBsYXllcih0YXJnZXQ6IEFOSU1BVElPTl9UWVBFKSB7XG4gICAgICAgIHN3aXRjaCAodGFyZ2V0KSB7XG4gICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9UWVBFLkNMT1NFOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUFuaW1hdGlvblBsYXllci5yZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbG9zZUFuaW1hdGlvblBsYXllciA9IG51bGw7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHRoaXMuY2xvc2VJbnRlcnJ1cHRlZCA9IHRydWU7XG4gICAgICAgICAgICAgICAgdGhpcy5vbkNsb3NlZENhbGxiYWNrID0gdGhpcy5fZGVmYXVsdENsb3NlZENhbGxiYWNrO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fVFlQRS5PUEVOOlxuICAgICAgICAgICAgICAgIGlmICh0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXIgIT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXIucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuQW5pbWF0aW9uUGxheWVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcGVuQW5pbWF0aW9uUGxheWVyID0gbnVsbDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgdGhpcy5vcGVuSW50ZXJydXB0ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRoaXMub25PcGVuZWRDYWxsYmFjayA9IHRoaXMuX2RlZmF1bHRPcGVuZWRDYWxsYmFjaztcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFBsYXllcih0eXBlOiBBTklNQVRJT05fVFlQRSk6IEFuaW1hdGlvblBsYXllciB7XG4gICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgY2FzZSBBTklNQVRJT05fVFlQRS5PUEVOOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm9wZW5BbmltYXRpb25QbGF5ZXI7XG4gICAgICAgICAgICBjYXNlIEFOSU1BVElPTl9UWVBFLkNMT1NFOlxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmNsb3NlQW5pbWF0aW9uUGxheWVyO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cbn1cbiJdfQ==