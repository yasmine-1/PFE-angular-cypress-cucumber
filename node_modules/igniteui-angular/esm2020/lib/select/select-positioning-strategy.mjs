import { __decorate, __param } from "tslib";
import { VerticalAlignment, HorizontalAlignment, Util } from '../services/overlay/utilities';
import { fadeOut, fadeIn } from '../animations/main';
import { BaseFitPositionStrategy } from '../services/overlay/position/base-fit-position-strategy';
import { Optional } from '@angular/core';
/** @hidden @internal */
let SelectPositioningStrategy = class SelectPositioningStrategy extends BaseFitPositionStrategy {
    constructor(select, settings, platform) {
        super();
        this.select = select;
        this.platform = platform;
        this._selectDefaultSettings = {
            horizontalDirection: HorizontalAlignment.Right,
            verticalDirection: VerticalAlignment.Bottom,
            horizontalStartPoint: HorizontalAlignment.Left,
            verticalStartPoint: VerticalAlignment.Top,
            openAnimation: fadeIn,
            closeAnimation: fadeOut
        };
        // Global variables required for cases of !initialCall (page scroll/overlay repositionAll)
        this.global_yOffset = 0;
        this.global_xOffset = 0;
        this.global_styles = {};
        this.settings = Object.assign({}, this._selectDefaultSettings, settings);
    }
    /** @inheritdoc */
    position(contentElement, size, document, initialCall, target) {
        const targetElement = target || this.settings.target;
        const rects = super.calculateElementRectangles(contentElement, targetElement);
        // selectFit obj, to be used for both cases of initialCall and !initialCall(page scroll/overlay repositionAll)
        const selectFit = {
            verticalOffset: this.global_yOffset,
            horizontalOffset: this.global_xOffset,
            targetRect: rects.targetRect,
            contentElementRect: rects.elementRect,
            styles: this.global_styles,
            scrollContainer: this.select.scrollContainer,
            scrollContainerRect: this.select.scrollContainer.getBoundingClientRect()
        };
        if (initialCall) {
            this.select.scrollContainer.scrollTop = 0;
            // Fill in the required selectFit object properties.
            selectFit.viewPortRect = Util.getViewportRect(document);
            selectFit.itemElement = this.getInteractionItemElement();
            selectFit.itemRect = selectFit.itemElement.getBoundingClientRect();
            // Calculate input and selected item elements style related variables
            selectFit.styles = this.calculateStyles(selectFit, targetElement);
            selectFit.scrollAmount = this.calculateScrollAmount(selectFit);
            // Calculate how much to offset the overlay container.
            this.calculateYoffset(selectFit);
            this.calculateXoffset(selectFit);
            super.updateViewPortFit(selectFit);
            // container does not fit in viewPort and is out on Top or Bottom
            if (selectFit.fitVertical.back < 0 || selectFit.fitVertical.forward < 0) {
                this.fitInViewport(contentElement, selectFit);
            }
            // Calculate scrollTop independently of the dropdown, as we cover all `igsSelect` specific positioning and
            // scrolling to selected item scenarios here.
            this.select.scrollContainer.scrollTop = selectFit.scrollAmount;
        }
        this.setStyles(contentElement, selectFit);
    }
    /**
     * Obtain the selected item if there is such one or otherwise use the first one
     */
    getInteractionItemElement() {
        let itemElement;
        if (this.select.selectedItem) {
            itemElement = this.select.selectedItem.element.nativeElement;
        }
        else {
            itemElement = this.select.getFirstItemElement();
        }
        return itemElement;
    }
    /**
     * Position the items outer container so selected item text is positioned over input text and if header
     * And/OR footer - both header/footer are visible
     *
     * @param selectFit selectFit to use for computation.
     */
    fitInViewport(contentElement, selectFit) {
        const footer = selectFit.scrollContainerRect.bottom - selectFit.contentElementRect.bottom;
        const header = selectFit.scrollContainerRect.top - selectFit.contentElementRect.top;
        const lastItemFitSize = selectFit.targetRect.bottom + selectFit.styles.itemTextToInputTextDiff - footer;
        const firstItemFitSize = selectFit.targetRect.top - selectFit.styles.itemTextToInputTextDiff - header;
        // out of viewPort on Top
        if (selectFit.fitVertical.back < 0) {
            const possibleScrollAmount = selectFit.scrollContainer.scrollHeight -
                selectFit.scrollContainerRect.height - selectFit.scrollAmount;
            if (possibleScrollAmount + selectFit.fitVertical.back > 0 && firstItemFitSize > selectFit.viewPortRect.top) {
                selectFit.scrollAmount -= selectFit.fitVertical.back;
                selectFit.verticalOffset -= selectFit.fitVertical.back;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = 0;
                this.global_yOffset = 0;
            }
            // out of viewPort on Bottom
        }
        else if (selectFit.fitVertical.forward < 0) {
            if (selectFit.scrollAmount + selectFit.fitVertical.forward > 0 && lastItemFitSize < selectFit.viewPortRect.bottom) {
                selectFit.scrollAmount += selectFit.fitVertical.forward;
                selectFit.verticalOffset += selectFit.fitVertical.forward;
                this.global_yOffset = selectFit.verticalOffset;
            }
            else {
                selectFit.verticalOffset = -selectFit.contentElementRect.height + selectFit.targetRect.height;
                this.global_yOffset = selectFit.verticalOffset;
            }
        }
    }
    /**
     * Sets element's style which effectively positions the provided element
     *
     * @param element Element to position
     * @param selectFit selectFit to use for computation.
     * @param initialCall should be true if this is the initial call to the position method calling setStyles
     */
    setStyles(contentElement, selectFit) {
        super.setStyle(contentElement, selectFit.targetRect, selectFit.contentElementRect, selectFit);
        contentElement.style.width = `${selectFit.styles.contentElementNewWidth}px`; // manage container based on paddings?
        this.global_styles.contentElementNewWidth = selectFit.styles.contentElementNewWidth;
    }
    /**
     * Calculate selected item scroll position.
     */
    calculateScrollAmount(selectFit) {
        const itemElementRect = selectFit.itemRect;
        const scrollContainer = selectFit.scrollContainer;
        const scrollContainerRect = selectFit.scrollContainerRect;
        const scrollDelta = scrollContainerRect.top - itemElementRect.top;
        let scrollPosition = scrollContainer.scrollTop - scrollDelta;
        const dropDownHeight = scrollContainer.clientHeight;
        scrollPosition -= dropDownHeight / 2;
        scrollPosition += itemElementRect.height / 2;
        return Math.round(Math.min(Math.max(0, scrollPosition), scrollContainer.scrollHeight - scrollContainerRect.height));
    }
    /**
     * Calculate the necessary input and selected item styles to be used for positioning item text over input text.
     * Calculate & Set default items container width.
     *
     * @param selectFit selectFit to use for computation.
     */
    calculateStyles(selectFit, target) {
        const styles = {};
        const inputElementStyles = window.getComputedStyle(target);
        const itemElementStyles = window.getComputedStyle(selectFit.itemElement);
        const numericInputFontSize = parseFloat(inputElementStyles.fontSize);
        const numericItemFontSize = parseFloat(itemElementStyles.fontSize);
        const inputTextToInputTop = (selectFit.targetRect.bottom - selectFit.targetRect.top - numericInputFontSize) / 2;
        const itemTextToItemTop = (selectFit.itemRect.height - numericItemFontSize) / 2;
        // Adjust for input top padding
        const negateInputPaddings = (parseFloat(inputElementStyles.paddingTop) -
            parseFloat(inputElementStyles.paddingBottom)) / 2;
        styles.itemTextToInputTextDiff = Math.round(itemTextToItemTop - inputTextToInputTop + negateInputPaddings);
        const numericLeftPadding = parseFloat(itemElementStyles.paddingLeft);
        const numericTextIndent = parseFloat(itemElementStyles.textIndent);
        styles.itemTextPadding = numericLeftPadding;
        styles.itemTextIndent = numericTextIndent;
        // 24 is the input's toggle ddl icon width
        styles.contentElementNewWidth = selectFit.targetRect.width + 24 + numericLeftPadding * 2;
        return styles;
    }
    /**
     * Calculate how much to offset the overlay container for Y-axis.
     */
    calculateYoffset(selectFit) {
        selectFit.verticalOffset = -(selectFit.itemRect.top - selectFit.contentElementRect.top +
            selectFit.styles.itemTextToInputTextDiff - selectFit.scrollAmount);
        this.global_yOffset = selectFit.verticalOffset;
    }
    /**
     * Calculate how much to offset the overlay container for X-axis.
     */
    calculateXoffset(selectFit) {
        selectFit.horizontalOffset = selectFit.styles.itemTextIndent - selectFit.styles.itemTextPadding;
        this.global_xOffset = selectFit.horizontalOffset;
    }
};
SelectPositioningStrategy = __decorate([
    __param(2, Optional())
], SelectPositioningStrategy);
export { SelectPositioningStrategy };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0LXBvc2l0aW9uaW5nLXN0cmF0ZWd5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvaWduaXRldWktYW5ndWxhci9zcmMvbGliL3NlbGVjdC9zZWxlY3QtcG9zaXRpb25pbmctc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxtQkFBbUIsRUFBMEIsSUFBSSxFQUF3QixNQUFNLCtCQUErQixDQUFDO0FBRTNJLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFckQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0seURBQXlELENBQUM7QUFFbEcsT0FBTyxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV6Qyx3QkFBd0I7QUFDeEIsSUFBYSx5QkFBeUIsR0FBdEMsTUFBYSx5QkFBMEIsU0FBUSx1QkFBdUI7SUFrQmxFLFlBQW1CLE1BQXFCLEVBQUUsUUFBMkIsRUFBd0IsUUFBdUI7UUFDaEgsS0FBSyxFQUFFLENBQUM7UUFETyxXQUFNLEdBQU4sTUFBTSxDQUFlO1FBQXFELGFBQVEsR0FBUixRQUFRLENBQWU7UUFkNUcsMkJBQXNCLEdBQUc7WUFDN0IsbUJBQW1CLEVBQUUsbUJBQW1CLENBQUMsS0FBSztZQUM5QyxpQkFBaUIsRUFBRSxpQkFBaUIsQ0FBQyxNQUFNO1lBQzNDLG9CQUFvQixFQUFFLG1CQUFtQixDQUFDLElBQUk7WUFDOUMsa0JBQWtCLEVBQUUsaUJBQWlCLENBQUMsR0FBRztZQUN6QyxhQUFhLEVBQUUsTUFBTTtZQUNyQixjQUFjLEVBQUUsT0FBTztTQUMxQixDQUFDO1FBRUYsMEZBQTBGO1FBQ2xGLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLG1CQUFjLEdBQUcsQ0FBQyxDQUFDO1FBQ25CLGtCQUFhLEdBQWlCLEVBQUUsQ0FBQztRQUlyQyxJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM3RSxDQUFDO0lBRUQsa0JBQWtCO0lBQ1gsUUFBUSxDQUFDLGNBQTJCLEVBQzNCLElBQVUsRUFDVixRQUFtQixFQUNuQixXQUFxQixFQUNyQixNQUE0QjtRQUN4QyxNQUFNLGFBQWEsR0FBRyxNQUFNLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUM7UUFDckQsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLDBCQUEwQixDQUFDLGNBQWMsRUFBRSxhQUFhLENBQUMsQ0FBQztRQUM5RSw4R0FBOEc7UUFDOUcsTUFBTSxTQUFTLEdBQWM7WUFDekIsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjO1lBQ25DLGdCQUFnQixFQUFFLElBQUksQ0FBQyxjQUFjO1lBQ3JDLFVBQVUsRUFBRSxLQUFLLENBQUMsVUFBVTtZQUM1QixrQkFBa0IsRUFBRSxLQUFLLENBQUMsV0FBVztZQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWE7WUFDMUIsZUFBZSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZTtZQUM1QyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxxQkFBcUIsRUFBRTtTQUMzRSxDQUFDO1FBRUYsSUFBSSxXQUFXLEVBQUU7WUFDYixJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQzFDLG9EQUFvRDtZQUNwRCxTQUFTLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEQsU0FBUyxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMseUJBQXlCLEVBQUUsQ0FBQztZQUN6RCxTQUFTLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQyxXQUFXLENBQUMscUJBQXFCLEVBQUUsQ0FBQztZQUVuRSxxRUFBcUU7WUFDckUsU0FBUyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUVsRSxTQUFTLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUMvRCxzREFBc0Q7WUFDdEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2pDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUVqQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDbkMsaUVBQWlFO1lBQ2pFLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRTtnQkFDckUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7YUFDakQ7WUFDRCwwR0FBMEc7WUFDMUcsNkNBQTZDO1lBQzdDLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDO1NBQ2xFO1FBQ0QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVEOztPQUVHO0lBQ0kseUJBQXlCO1FBQzVCLElBQUksV0FBVyxDQUFDO1FBQ2hCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLEVBQUU7WUFDMUIsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUM7U0FDaEU7YUFBTTtZQUNILFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixFQUFFLENBQUM7U0FDbkQ7UUFDRCxPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDTyxhQUFhLENBQUMsY0FBMkIsRUFBRSxTQUFvQjtRQUNyRSxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUM7UUFDMUYsTUFBTSxNQUFNLEdBQUcsU0FBUyxDQUFDLG1CQUFtQixDQUFDLEdBQUcsR0FBRyxTQUFTLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDO1FBQ3BGLE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsdUJBQXVCLEdBQUcsTUFBTSxDQUFDO1FBQ3hHLE1BQU0sZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsR0FBRyxNQUFNLENBQUM7UUFDdEcseUJBQXlCO1FBQ3pCLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFO1lBQ2hDLE1BQU0sb0JBQW9CLEdBQUcsU0FBUyxDQUFDLGVBQWUsQ0FBQyxZQUFZO2dCQUMvRCxTQUFTLENBQUMsbUJBQW1CLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxZQUFZLENBQUM7WUFDbEUsSUFBSSxvQkFBb0IsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxDQUFDLElBQUksZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUU7Z0JBQ3hHLFNBQVMsQ0FBQyxZQUFZLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7Z0JBQ3JELFNBQVMsQ0FBQyxjQUFjLElBQUksU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUM7Z0JBQ3ZELElBQUksQ0FBQyxjQUFjLEdBQUcsU0FBUyxDQUFDLGNBQWMsQ0FBQzthQUNsRDtpQkFBTTtnQkFDSCxTQUFTLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBRTtnQkFDOUIsSUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7YUFDM0I7WUFDTCw0QkFBNEI7U0FDM0I7YUFBTSxJQUFJLFNBQVMsQ0FBQyxXQUFXLENBQUMsT0FBTyxHQUFHLENBQUMsRUFBRTtZQUMxQyxJQUFJLFNBQVMsQ0FBQyxZQUFZLEdBQUcsU0FBUyxDQUFDLFdBQVcsQ0FBQyxPQUFPLEdBQUcsQ0FBQyxJQUFJLGVBQWUsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLE1BQU0sRUFBRTtnQkFDL0csU0FBUyxDQUFDLFlBQVksSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztnQkFDeEQsU0FBUyxDQUFDLGNBQWMsSUFBSSxTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQztnQkFDMUQsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDO2FBQ2xEO2lCQUFNO2dCQUNILFNBQVMsQ0FBQyxjQUFjLEdBQUcsQ0FBQyxTQUFTLENBQUMsa0JBQWtCLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDO2dCQUM5RixJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQyxjQUFjLENBQUM7YUFDbEQ7U0FDSjtJQUNMLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDTyxTQUFTLENBQUMsY0FBMkIsRUFBRSxTQUFvQjtRQUNqRSxLQUFLLENBQUMsUUFBUSxDQUFDLGNBQWMsRUFBRSxTQUFTLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxrQkFBa0IsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUM5RixjQUFjLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsc0JBQXNCLElBQUksQ0FBQyxDQUFDLHNDQUFzQztRQUNuSCxJQUFJLENBQUMsYUFBYSxDQUFDLHNCQUFzQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsc0JBQXNCLENBQUM7SUFDeEYsQ0FBQztJQUVEOztPQUVHO0lBQ0sscUJBQXFCLENBQUMsU0FBb0I7UUFDOUMsTUFBTSxlQUFlLEdBQUcsU0FBUyxDQUFDLFFBQVEsQ0FBQztRQUMzQyxNQUFNLGVBQWUsR0FBRyxTQUFTLENBQUMsZUFBZSxDQUFDO1FBQ2xELE1BQU0sbUJBQW1CLEdBQUcsU0FBUyxDQUFDLG1CQUFtQixDQUFDO1FBQzFELE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDLEdBQUcsR0FBRyxlQUFlLENBQUMsR0FBRyxDQUFDO1FBQ2xFLElBQUksY0FBYyxHQUFHLGVBQWUsQ0FBQyxTQUFTLEdBQUcsV0FBVyxDQUFDO1FBRTdELE1BQU0sY0FBYyxHQUFHLGVBQWUsQ0FBQyxZQUFZLENBQUM7UUFDcEQsY0FBYyxJQUFJLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFDckMsY0FBYyxJQUFJLGVBQWUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBRTdDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLGNBQWMsQ0FBQyxFQUFFLGVBQWUsQ0FBQyxZQUFZLEdBQUcsbUJBQW1CLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUN4SCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxlQUFlLENBQUMsU0FBb0IsRUFBRSxNQUEyQjtRQUNyRSxNQUFNLE1BQU0sR0FBaUIsRUFBRSxDQUFDO1FBQ2hDLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE1BQWlCLENBQUMsQ0FBQztRQUN0RSxNQUFNLGlCQUFpQixHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDekUsTUFBTSxvQkFBb0IsR0FBRyxVQUFVLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDckUsTUFBTSxtQkFBbUIsR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbkUsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsR0FBRyxHQUFHLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2hILE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUMvRSwrQkFBK0I7UUFDaEMsTUFBTSxtQkFBbUIsR0FBRyxDQUNwQixVQUFVLENBQUMsa0JBQWtCLENBQUMsVUFBVSxDQUFDO1lBQ3pDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxhQUFhLENBQUMsQ0FDL0MsR0FBRyxDQUFDLENBQUM7UUFDVixNQUFNLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxtQkFBbUIsR0FBRyxtQkFBbUIsQ0FBQyxDQUFDO1FBRTNHLE1BQU0sa0JBQWtCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3JFLE1BQU0saUJBQWlCLEdBQUcsVUFBVSxDQUFDLGlCQUFpQixDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBRW5FLE1BQU0sQ0FBQyxlQUFlLEdBQUcsa0JBQWtCLENBQUM7UUFDNUMsTUFBTSxDQUFDLGNBQWMsR0FBRyxpQkFBaUIsQ0FBQztRQUMxQywwQ0FBMEM7UUFDMUMsTUFBTSxDQUFDLHNCQUFzQixHQUFHLFNBQVMsQ0FBQyxVQUFVLENBQUMsS0FBSyxHQUFHLEVBQUUsR0FBRyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7UUFFekYsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssZ0JBQWdCLENBQUMsU0FBb0I7UUFDekMsU0FBUyxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsU0FBUyxDQUFDLGtCQUFrQixDQUFDLEdBQUc7WUFDbEYsU0FBUyxDQUFDLE1BQU0sQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDdkUsSUFBSSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsY0FBYyxDQUFDO0lBQ25ELENBQUM7SUFFRDs7T0FFRztJQUNLLGdCQUFnQixDQUFDLFNBQW9CO1FBQ3pDLFNBQVMsQ0FBQyxnQkFBZ0IsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLGNBQWMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQztRQUNoRyxJQUFJLENBQUMsY0FBYyxHQUFHLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQztJQUNyRCxDQUFDO0NBQ0osQ0FBQTtBQXBNWSx5QkFBeUI7SUFrQnNDLFdBQUEsUUFBUSxFQUFFLENBQUE7R0FsQnpFLHlCQUF5QixDQW9NckM7U0FwTVkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmVydGljYWxBbGlnbm1lbnQsIEhvcml6b250YWxBbGlnbm1lbnQsIFBvc2l0aW9uU2V0dGluZ3MsIFNpemUsIFV0aWwsIENvbm5lY3RlZEZpdCwgUG9pbnQgIH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS91dGlsaXRpZXMnO1xuaW1wb3J0IHsgSVBvc2l0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9zZXJ2aWNlcy9vdmVybGF5L3Bvc2l0aW9uJztcbmltcG9ydCB7IGZhZGVPdXQsIGZhZGVJbiB9IGZyb20gJy4uL2FuaW1hdGlvbnMvbWFpbic7XG5pbXBvcnQgeyBJZ3hTZWxlY3RCYXNlIH0gZnJvbSAnLi9zZWxlY3QuY29tbW9uJztcbmltcG9ydCB7IEJhc2VGaXRQb3NpdGlvblN0cmF0ZWd5IH0gZnJvbSAnLi4vc2VydmljZXMvb3ZlcmxheS9wb3NpdGlvbi9iYXNlLWZpdC1wb3NpdGlvbi1zdHJhdGVneSc7XG5pbXBvcnQgeyBQbGF0Zm9ybVV0aWwgfSBmcm9tICcuLi9jb3JlL3V0aWxzJztcbmltcG9ydCB7IE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbi8qKiBAaGlkZGVuIEBpbnRlcm5hbCAqL1xuZXhwb3J0IGNsYXNzIFNlbGVjdFBvc2l0aW9uaW5nU3RyYXRlZ3kgZXh0ZW5kcyBCYXNlRml0UG9zaXRpb25TdHJhdGVneSBpbXBsZW1lbnRzIElQb3NpdGlvblN0cmF0ZWd5IHtcbiAgICAvKiogQGluaGVyaXRkb2MgKi9cbiAgICBwdWJsaWMgc2V0dGluZ3M6IFBvc2l0aW9uU2V0dGluZ3M7XG5cbiAgICBwcml2YXRlIF9zZWxlY3REZWZhdWx0U2V0dGluZ3MgPSB7XG4gICAgICAgIGhvcml6b250YWxEaXJlY3Rpb246IEhvcml6b250YWxBbGlnbm1lbnQuUmlnaHQsXG4gICAgICAgIHZlcnRpY2FsRGlyZWN0aW9uOiBWZXJ0aWNhbEFsaWdubWVudC5Cb3R0b20sXG4gICAgICAgIGhvcml6b250YWxTdGFydFBvaW50OiBIb3Jpem9udGFsQWxpZ25tZW50LkxlZnQsXG4gICAgICAgIHZlcnRpY2FsU3RhcnRQb2ludDogVmVydGljYWxBbGlnbm1lbnQuVG9wLFxuICAgICAgICBvcGVuQW5pbWF0aW9uOiBmYWRlSW4sXG4gICAgICAgIGNsb3NlQW5pbWF0aW9uOiBmYWRlT3V0XG4gICAgfTtcblxuICAgIC8vIEdsb2JhbCB2YXJpYWJsZXMgcmVxdWlyZWQgZm9yIGNhc2VzIG9mICFpbml0aWFsQ2FsbCAocGFnZSBzY3JvbGwvb3ZlcmxheSByZXBvc2l0aW9uQWxsKVxuICAgIHByaXZhdGUgZ2xvYmFsX3lPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3hPZmZzZXQgPSAwO1xuICAgIHByaXZhdGUgZ2xvYmFsX3N0eWxlczogU2VsZWN0U3R5bGVzID0ge307XG5cbiAgICBjb25zdHJ1Y3RvcihwdWJsaWMgc2VsZWN0OiBJZ3hTZWxlY3RCYXNlLCBzZXR0aW5ncz86IFBvc2l0aW9uU2V0dGluZ3MsIEBPcHRpb25hbCgpIHByb3RlY3RlZCBwbGF0Zm9ybT86IFBsYXRmb3JtVXRpbCkge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLnNldHRpbmdzID0gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5fc2VsZWN0RGVmYXVsdFNldHRpbmdzLCBzZXR0aW5ncyk7XG4gICAgfVxuXG4gICAgLyoqIEBpbmhlcml0ZG9jICovXG4gICAgcHVibGljIHBvc2l0aW9uKGNvbnRlbnRFbGVtZW50OiBIVE1MRWxlbWVudCxcbiAgICAgICAgICAgICAgICAgICAgc2l6ZTogU2l6ZSxcbiAgICAgICAgICAgICAgICAgICAgZG9jdW1lbnQ/OiBEb2N1bWVudCxcbiAgICAgICAgICAgICAgICAgICAgaW5pdGlhbENhbGw/OiBib29sZWFuLFxuICAgICAgICAgICAgICAgICAgICB0YXJnZXQ/OiBQb2ludCB8IEhUTUxFbGVtZW50KTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHRhcmdldEVsZW1lbnQgPSB0YXJnZXQgfHwgdGhpcy5zZXR0aW5ncy50YXJnZXQ7XG4gICAgICAgIGNvbnN0IHJlY3RzID0gc3VwZXIuY2FsY3VsYXRlRWxlbWVudFJlY3RhbmdsZXMoY29udGVudEVsZW1lbnQsIHRhcmdldEVsZW1lbnQpO1xuICAgICAgICAvLyBzZWxlY3RGaXQgb2JqLCB0byBiZSB1c2VkIGZvciBib3RoIGNhc2VzIG9mIGluaXRpYWxDYWxsIGFuZCAhaW5pdGlhbENhbGwocGFnZSBzY3JvbGwvb3ZlcmxheSByZXBvc2l0aW9uQWxsKVxuICAgICAgICBjb25zdCBzZWxlY3RGaXQ6IFNlbGVjdEZpdCA9IHtcbiAgICAgICAgICAgIHZlcnRpY2FsT2Zmc2V0OiB0aGlzLmdsb2JhbF95T2Zmc2V0LFxuICAgICAgICAgICAgaG9yaXpvbnRhbE9mZnNldDogdGhpcy5nbG9iYWxfeE9mZnNldCxcbiAgICAgICAgICAgIHRhcmdldFJlY3Q6IHJlY3RzLnRhcmdldFJlY3QsXG4gICAgICAgICAgICBjb250ZW50RWxlbWVudFJlY3Q6IHJlY3RzLmVsZW1lbnRSZWN0LFxuICAgICAgICAgICAgc3R5bGVzOiB0aGlzLmdsb2JhbF9zdHlsZXMsXG4gICAgICAgICAgICBzY3JvbGxDb250YWluZXI6IHRoaXMuc2VsZWN0LnNjcm9sbENvbnRhaW5lcixcbiAgICAgICAgICAgIHNjcm9sbENvbnRhaW5lclJlY3Q6IHRoaXMuc2VsZWN0LnNjcm9sbENvbnRhaW5lci5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChpbml0aWFsQ2FsbCkge1xuICAgICAgICAgICAgdGhpcy5zZWxlY3Quc2Nyb2xsQ29udGFpbmVyLnNjcm9sbFRvcCA9IDA7XG4gICAgICAgICAgICAvLyBGaWxsIGluIHRoZSByZXF1aXJlZCBzZWxlY3RGaXQgb2JqZWN0IHByb3BlcnRpZXMuXG4gICAgICAgICAgICBzZWxlY3RGaXQudmlld1BvcnRSZWN0ID0gVXRpbC5nZXRWaWV3cG9ydFJlY3QoZG9jdW1lbnQpO1xuICAgICAgICAgICAgc2VsZWN0Rml0Lml0ZW1FbGVtZW50ID0gdGhpcy5nZXRJbnRlcmFjdGlvbkl0ZW1FbGVtZW50KCk7XG4gICAgICAgICAgICBzZWxlY3RGaXQuaXRlbVJlY3QgPSBzZWxlY3RGaXQuaXRlbUVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG5cbiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBpbnB1dCBhbmQgc2VsZWN0ZWQgaXRlbSBlbGVtZW50cyBzdHlsZSByZWxhdGVkIHZhcmlhYmxlc1xuICAgICAgICAgICAgc2VsZWN0Rml0LnN0eWxlcyA9IHRoaXMuY2FsY3VsYXRlU3R5bGVzKHNlbGVjdEZpdCwgdGFyZ2V0RWxlbWVudCk7XG5cbiAgICAgICAgICAgIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgPSB0aGlzLmNhbGN1bGF0ZVNjcm9sbEFtb3VudChzZWxlY3RGaXQpO1xuICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIGhvdyBtdWNoIHRvIG9mZnNldCB0aGUgb3ZlcmxheSBjb250YWluZXIuXG4gICAgICAgICAgICB0aGlzLmNhbGN1bGF0ZVlvZmZzZXQoc2VsZWN0Rml0KTtcbiAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlWG9mZnNldChzZWxlY3RGaXQpO1xuXG4gICAgICAgICAgICBzdXBlci51cGRhdGVWaWV3UG9ydEZpdChzZWxlY3RGaXQpO1xuICAgICAgICAgICAgLy8gY29udGFpbmVyIGRvZXMgbm90IGZpdCBpbiB2aWV3UG9ydCBhbmQgaXMgb3V0IG9uIFRvcCBvciBCb3R0b21cbiAgICAgICAgICAgIGlmIChzZWxlY3RGaXQuZml0VmVydGljYWwuYmFjayA8IDAgfHwgc2VsZWN0Rml0LmZpdFZlcnRpY2FsLmZvcndhcmQgPCAwKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5maXRJblZpZXdwb3J0KGNvbnRlbnRFbGVtZW50LCBzZWxlY3RGaXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gQ2FsY3VsYXRlIHNjcm9sbFRvcCBpbmRlcGVuZGVudGx5IG9mIHRoZSBkcm9wZG93biwgYXMgd2UgY292ZXIgYWxsIGBpZ3NTZWxlY3RgIHNwZWNpZmljIHBvc2l0aW9uaW5nIGFuZFxuICAgICAgICAgICAgLy8gc2Nyb2xsaW5nIHRvIHNlbGVjdGVkIGl0ZW0gc2NlbmFyaW9zIGhlcmUuXG4gICAgICAgICAgICB0aGlzLnNlbGVjdC5zY3JvbGxDb250YWluZXIuc2Nyb2xsVG9wID0gc2VsZWN0Rml0LnNjcm9sbEFtb3VudDtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNldFN0eWxlcyhjb250ZW50RWxlbWVudCwgc2VsZWN0Rml0KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBPYnRhaW4gdGhlIHNlbGVjdGVkIGl0ZW0gaWYgdGhlcmUgaXMgc3VjaCBvbmUgb3Igb3RoZXJ3aXNlIHVzZSB0aGUgZmlyc3Qgb25lXG4gICAgICovXG4gICAgcHVibGljIGdldEludGVyYWN0aW9uSXRlbUVsZW1lbnQoKTogSFRNTEVsZW1lbnQge1xuICAgICAgICBsZXQgaXRlbUVsZW1lbnQ7XG4gICAgICAgIGlmICh0aGlzLnNlbGVjdC5zZWxlY3RlZEl0ZW0pIHtcbiAgICAgICAgICAgIGl0ZW1FbGVtZW50ID0gdGhpcy5zZWxlY3Quc2VsZWN0ZWRJdGVtLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGl0ZW1FbGVtZW50ID0gdGhpcy5zZWxlY3QuZ2V0Rmlyc3RJdGVtRWxlbWVudCgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpdGVtRWxlbWVudDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3NpdGlvbiB0aGUgaXRlbXMgb3V0ZXIgY29udGFpbmVyIHNvIHNlbGVjdGVkIGl0ZW0gdGV4dCBpcyBwb3NpdGlvbmVkIG92ZXIgaW5wdXQgdGV4dCBhbmQgaWYgaGVhZGVyXG4gICAgICogQW5kL09SIGZvb3RlciAtIGJvdGggaGVhZGVyL2Zvb3RlciBhcmUgdmlzaWJsZVxuICAgICAqXG4gICAgICogQHBhcmFtIHNlbGVjdEZpdCBzZWxlY3RGaXQgdG8gdXNlIGZvciBjb21wdXRhdGlvbi5cbiAgICAgKi9cbiAgICBwcm90ZWN0ZWQgZml0SW5WaWV3cG9ydChjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIHNlbGVjdEZpdDogU2VsZWN0Rml0KSB7XG4gICAgICAgIGNvbnN0IGZvb3RlciA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXJSZWN0LmJvdHRvbSAtIHNlbGVjdEZpdC5jb250ZW50RWxlbWVudFJlY3QuYm90dG9tO1xuICAgICAgICBjb25zdCBoZWFkZXIgPSBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyUmVjdC50b3AgLSBzZWxlY3RGaXQuY29udGVudEVsZW1lbnRSZWN0LnRvcDtcbiAgICAgICAgY29uc3QgbGFzdEl0ZW1GaXRTaXplID0gc2VsZWN0Rml0LnRhcmdldFJlY3QuYm90dG9tICsgc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiAtIGZvb3RlcjtcbiAgICAgICAgY29uc3QgZmlyc3RJdGVtRml0U2l6ZSA9IHNlbGVjdEZpdC50YXJnZXRSZWN0LnRvcCAtIHNlbGVjdEZpdC5zdHlsZXMuaXRlbVRleHRUb0lucHV0VGV4dERpZmYgLSBoZWFkZXI7XG4gICAgICAgIC8vIG91dCBvZiB2aWV3UG9ydCBvbiBUb3BcbiAgICAgICAgaWYgKHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrIDwgMCkge1xuICAgICAgICAgICAgY29uc3QgcG9zc2libGVTY3JvbGxBbW91bnQgPSBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyLnNjcm9sbEhlaWdodCAtXG4gICAgICAgICAgICAgICAgc2VsZWN0Rml0LnNjcm9sbENvbnRhaW5lclJlY3QuaGVpZ2h0IC0gc2VsZWN0Rml0LnNjcm9sbEFtb3VudDtcbiAgICAgICAgICAgIGlmIChwb3NzaWJsZVNjcm9sbEFtb3VudCArIHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrID4gMCAmJiBmaXJzdEl0ZW1GaXRTaXplID4gc2VsZWN0Rml0LnZpZXdQb3J0UmVjdC50b3ApIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50IC09IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5iYWNrO1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCAtPSBzZWxlY3RGaXQuZml0VmVydGljYWwuYmFjaztcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQgPSAwIDtcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgLy8gb3V0IG9mIHZpZXdQb3J0IG9uIEJvdHRvbVxuICAgICAgICB9IGVsc2UgaWYgKHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkIDwgMCkge1xuICAgICAgICAgICAgaWYgKHNlbGVjdEZpdC5zY3JvbGxBbW91bnQgKyBzZWxlY3RGaXQuZml0VmVydGljYWwuZm9yd2FyZCA+IDAgJiYgbGFzdEl0ZW1GaXRTaXplIDwgc2VsZWN0Rml0LnZpZXdQb3J0UmVjdC5ib3R0b20pIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQuc2Nyb2xsQW1vdW50ICs9IHNlbGVjdEZpdC5maXRWZXJ0aWNhbC5mb3J3YXJkO1xuICAgICAgICAgICAgICAgIHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldCArPSBzZWxlY3RGaXQuZml0VmVydGljYWwuZm9yd2FyZDtcbiAgICAgICAgICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBzZWxlY3RGaXQudmVydGljYWxPZmZzZXQgPSAtc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdC5oZWlnaHQgKyBzZWxlY3RGaXQudGFyZ2V0UmVjdC5oZWlnaHQ7XG4gICAgICAgICAgICAgICAgdGhpcy5nbG9iYWxfeU9mZnNldCA9IHNlbGVjdEZpdC52ZXJ0aWNhbE9mZnNldDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldHMgZWxlbWVudCdzIHN0eWxlIHdoaWNoIGVmZmVjdGl2ZWx5IHBvc2l0aW9ucyB0aGUgcHJvdmlkZWQgZWxlbWVudFxuICAgICAqXG4gICAgICogQHBhcmFtIGVsZW1lbnQgRWxlbWVudCB0byBwb3NpdGlvblxuICAgICAqIEBwYXJhbSBzZWxlY3RGaXQgc2VsZWN0Rml0IHRvIHVzZSBmb3IgY29tcHV0YXRpb24uXG4gICAgICogQHBhcmFtIGluaXRpYWxDYWxsIHNob3VsZCBiZSB0cnVlIGlmIHRoaXMgaXMgdGhlIGluaXRpYWwgY2FsbCB0byB0aGUgcG9zaXRpb24gbWV0aG9kIGNhbGxpbmcgc2V0U3R5bGVzXG4gICAgICovXG4gICAgcHJvdGVjdGVkIHNldFN0eWxlcyhjb250ZW50RWxlbWVudDogSFRNTEVsZW1lbnQsIHNlbGVjdEZpdDogU2VsZWN0Rml0KSB7XG4gICAgICAgIHN1cGVyLnNldFN0eWxlKGNvbnRlbnRFbGVtZW50LCBzZWxlY3RGaXQudGFyZ2V0UmVjdCwgc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdCwgc2VsZWN0Rml0KTtcbiAgICAgICAgY29udGVudEVsZW1lbnQuc3R5bGUud2lkdGggPSBgJHtzZWxlY3RGaXQuc3R5bGVzLmNvbnRlbnRFbGVtZW50TmV3V2lkdGh9cHhgOyAvLyBtYW5hZ2UgY29udGFpbmVyIGJhc2VkIG9uIHBhZGRpbmdzP1xuICAgICAgICB0aGlzLmdsb2JhbF9zdHlsZXMuY29udGVudEVsZW1lbnROZXdXaWR0aCA9IHNlbGVjdEZpdC5zdHlsZXMuY29udGVudEVsZW1lbnROZXdXaWR0aDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgc2VsZWN0ZWQgaXRlbSBzY3JvbGwgcG9zaXRpb24uXG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVTY3JvbGxBbW91bnQoc2VsZWN0Rml0OiBTZWxlY3RGaXQpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBpdGVtRWxlbWVudFJlY3QgPSBzZWxlY3RGaXQuaXRlbVJlY3Q7XG4gICAgICAgIGNvbnN0IHNjcm9sbENvbnRhaW5lciA9IHNlbGVjdEZpdC5zY3JvbGxDb250YWluZXI7XG4gICAgICAgIGNvbnN0IHNjcm9sbENvbnRhaW5lclJlY3QgPSBzZWxlY3RGaXQuc2Nyb2xsQ29udGFpbmVyUmVjdDtcbiAgICAgICAgY29uc3Qgc2Nyb2xsRGVsdGEgPSBzY3JvbGxDb250YWluZXJSZWN0LnRvcCAtIGl0ZW1FbGVtZW50UmVjdC50b3A7XG4gICAgICAgIGxldCBzY3JvbGxQb3NpdGlvbiA9IHNjcm9sbENvbnRhaW5lci5zY3JvbGxUb3AgLSBzY3JvbGxEZWx0YTtcblxuICAgICAgICBjb25zdCBkcm9wRG93bkhlaWdodCA9IHNjcm9sbENvbnRhaW5lci5jbGllbnRIZWlnaHQ7XG4gICAgICAgIHNjcm9sbFBvc2l0aW9uIC09IGRyb3BEb3duSGVpZ2h0IC8gMjtcbiAgICAgICAgc2Nyb2xsUG9zaXRpb24gKz0gaXRlbUVsZW1lbnRSZWN0LmhlaWdodCAvIDI7XG5cbiAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoTWF0aC5taW4oTWF0aC5tYXgoMCwgc2Nyb2xsUG9zaXRpb24pLCBzY3JvbGxDb250YWluZXIuc2Nyb2xsSGVpZ2h0IC0gc2Nyb2xsQ29udGFpbmVyUmVjdC5oZWlnaHQpKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBDYWxjdWxhdGUgdGhlIG5lY2Vzc2FyeSBpbnB1dCBhbmQgc2VsZWN0ZWQgaXRlbSBzdHlsZXMgdG8gYmUgdXNlZCBmb3IgcG9zaXRpb25pbmcgaXRlbSB0ZXh0IG92ZXIgaW5wdXQgdGV4dC5cbiAgICAgKiBDYWxjdWxhdGUgJiBTZXQgZGVmYXVsdCBpdGVtcyBjb250YWluZXIgd2lkdGguXG4gICAgICpcbiAgICAgKiBAcGFyYW0gc2VsZWN0Rml0IHNlbGVjdEZpdCB0byB1c2UgZm9yIGNvbXB1dGF0aW9uLlxuICAgICAqL1xuICAgIHByaXZhdGUgY2FsY3VsYXRlU3R5bGVzKHNlbGVjdEZpdDogU2VsZWN0Rml0LCB0YXJnZXQ6IFBvaW50IHwgSFRNTEVsZW1lbnQpOiBTZWxlY3RTdHlsZXMgIHtcbiAgICAgICAgY29uc3Qgc3R5bGVzOiBTZWxlY3RTdHlsZXMgPSB7fTtcbiAgICAgICAgY29uc3QgaW5wdXRFbGVtZW50U3R5bGVzID0gd2luZG93LmdldENvbXB1dGVkU3R5bGUodGFyZ2V0IGFzIEVsZW1lbnQpO1xuICAgICAgICBjb25zdCBpdGVtRWxlbWVudFN0eWxlcyA9IHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHNlbGVjdEZpdC5pdGVtRWxlbWVudCk7XG4gICAgICAgIGNvbnN0IG51bWVyaWNJbnB1dEZvbnRTaXplID0gcGFyc2VGbG9hdChpbnB1dEVsZW1lbnRTdHlsZXMuZm9udFNpemUpO1xuICAgICAgICBjb25zdCBudW1lcmljSXRlbUZvbnRTaXplID0gcGFyc2VGbG9hdChpdGVtRWxlbWVudFN0eWxlcy5mb250U2l6ZSk7XG4gICAgICAgIGNvbnN0IGlucHV0VGV4dFRvSW5wdXRUb3AgPSAoc2VsZWN0Rml0LnRhcmdldFJlY3QuYm90dG9tIC0gc2VsZWN0Rml0LnRhcmdldFJlY3QudG9wIC0gbnVtZXJpY0lucHV0Rm9udFNpemUpIC8gMjtcbiAgICAgICAgY29uc3QgaXRlbVRleHRUb0l0ZW1Ub3AgPSAoc2VsZWN0Rml0Lml0ZW1SZWN0LmhlaWdodCAtIG51bWVyaWNJdGVtRm9udFNpemUpIC8gMjtcbiAgICAgICAgIC8vIEFkanVzdCBmb3IgaW5wdXQgdG9wIHBhZGRpbmdcbiAgICAgICAgY29uc3QgbmVnYXRlSW5wdXRQYWRkaW5ncyA9IChcbiAgICAgICAgICAgICAgICBwYXJzZUZsb2F0KGlucHV0RWxlbWVudFN0eWxlcy5wYWRkaW5nVG9wKSAtXG4gICAgICAgICAgICAgICAgcGFyc2VGbG9hdChpbnB1dEVsZW1lbnRTdHlsZXMucGFkZGluZ0JvdHRvbSlcbiAgICAgICAgICAgICkgLyAyO1xuICAgICAgICBzdHlsZXMuaXRlbVRleHRUb0lucHV0VGV4dERpZmYgPSBNYXRoLnJvdW5kKGl0ZW1UZXh0VG9JdGVtVG9wIC0gaW5wdXRUZXh0VG9JbnB1dFRvcCArIG5lZ2F0ZUlucHV0UGFkZGluZ3MpO1xuXG4gICAgICAgIGNvbnN0IG51bWVyaWNMZWZ0UGFkZGluZyA9IHBhcnNlRmxvYXQoaXRlbUVsZW1lbnRTdHlsZXMucGFkZGluZ0xlZnQpO1xuICAgICAgICBjb25zdCBudW1lcmljVGV4dEluZGVudCA9IHBhcnNlRmxvYXQoaXRlbUVsZW1lbnRTdHlsZXMudGV4dEluZGVudCk7XG5cbiAgICAgICAgc3R5bGVzLml0ZW1UZXh0UGFkZGluZyA9IG51bWVyaWNMZWZ0UGFkZGluZztcbiAgICAgICAgc3R5bGVzLml0ZW1UZXh0SW5kZW50ID0gbnVtZXJpY1RleHRJbmRlbnQ7XG4gICAgICAgIC8vIDI0IGlzIHRoZSBpbnB1dCdzIHRvZ2dsZSBkZGwgaWNvbiB3aWR0aFxuICAgICAgICBzdHlsZXMuY29udGVudEVsZW1lbnROZXdXaWR0aCA9IHNlbGVjdEZpdC50YXJnZXRSZWN0LndpZHRoICsgMjQgKyBudW1lcmljTGVmdFBhZGRpbmcgKiAyO1xuXG4gICAgICAgIHJldHVybiBzdHlsZXM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2FsY3VsYXRlIGhvdyBtdWNoIHRvIG9mZnNldCB0aGUgb3ZlcmxheSBjb250YWluZXIgZm9yIFktYXhpcy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGNhbGN1bGF0ZVlvZmZzZXQoc2VsZWN0Rml0OiBTZWxlY3RGaXQpIHtcbiAgICAgICAgc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0ID0gLShzZWxlY3RGaXQuaXRlbVJlY3QudG9wIC0gc2VsZWN0Rml0LmNvbnRlbnRFbGVtZW50UmVjdC50b3AgK1xuICAgICAgICAgICAgc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dFRvSW5wdXRUZXh0RGlmZiAtIHNlbGVjdEZpdC5zY3JvbGxBbW91bnQpO1xuICAgICAgICB0aGlzLmdsb2JhbF95T2Zmc2V0ID0gc2VsZWN0Rml0LnZlcnRpY2FsT2Zmc2V0O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGN1bGF0ZSBob3cgbXVjaCB0byBvZmZzZXQgdGhlIG92ZXJsYXkgY29udGFpbmVyIGZvciBYLWF4aXMuXG4gICAgICovXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVYb2Zmc2V0KHNlbGVjdEZpdDogU2VsZWN0Rml0KSB7XG4gICAgICAgIHNlbGVjdEZpdC5ob3Jpem9udGFsT2Zmc2V0ID0gc2VsZWN0Rml0LnN0eWxlcy5pdGVtVGV4dEluZGVudCAtIHNlbGVjdEZpdC5zdHlsZXMuaXRlbVRleHRQYWRkaW5nO1xuICAgICAgICB0aGlzLmdsb2JhbF94T2Zmc2V0ID0gc2VsZWN0Rml0Lmhvcml6b250YWxPZmZzZXQ7XG4gICAgfVxufVxuXG4vKiogQGhpZGRlbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RGaXQgZXh0ZW5kcyBDb25uZWN0ZWRGaXQge1xuICAgIGl0ZW1FbGVtZW50PzogSFRNTEVsZW1lbnQ7XG4gICAgc2Nyb2xsQ29udGFpbmVyOiBIVE1MRWxlbWVudDtcbiAgICBzY3JvbGxDb250YWluZXJSZWN0OiBDbGllbnRSZWN0O1xuICAgIGl0ZW1SZWN0PzogQ2xpZW50UmVjdDtcbiAgICBzdHlsZXM/OiBTZWxlY3RTdHlsZXM7XG4gICAgc2Nyb2xsQW1vdW50PzogbnVtYmVyO1xufVxuXG4vKiogQGhpZGRlbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZWxlY3RTdHlsZXMge1xuICAgIGl0ZW1UZXh0UGFkZGluZz86IG51bWJlcjtcbiAgICBpdGVtVGV4dEluZGVudD86IG51bWJlcjtcbiAgICBpdGVtVGV4dFRvSW5wdXRUZXh0RGlmZj86IG51bWJlcjtcbiAgICBjb250ZW50RWxlbWVudE5ld1dpZHRoPzogbnVtYmVyO1xuICAgIG51bWVyaWNMZWZ0UGFkZGluZz86IG51bWJlcjtcbn1cbiJdfQ==